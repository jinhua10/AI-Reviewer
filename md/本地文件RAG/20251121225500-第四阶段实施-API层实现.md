# 第四阶段实施：API层实现
## REST API与HTTP服务器

**创建时间**: 2025-11-21 22:50:00  
**阶段**: 第四阶段 (第7-8周)  
**负责模块**: local-file-rag-api  
**状态**: 进行中

---

## 1. 阶段目标

### 1.1 核心任务
- ✅ REST API设计
- ✅ Netty HTTP服务器实现
- ✅ CRUD端点实现
- ✅ 搜索端点实现
- ✅ 管理端点实现
- ✅ 错误处理
- ✅ API文档生成
- ✅ 请求验证

### 1.2 API端点设计

#### 文档管理端点
- `POST /api/documents` - 创建文档
- `GET /api/documents/{id}` - 获取文档
- `PUT /api/documents/{id}` - 更新文档
- `DELETE /api/documents/{id}` - 删除文档
- `GET /api/documents` - 列出文档

#### 搜索端点
- `POST /api/search` - 搜索文档
- `POST /api/search/advanced` - 高级搜索

#### 管理端点
- `GET /api/health` - 健康检查
- `GET /api/stats` - 统计信息
- `POST /api/admin/optimize` - 优化索引
- `POST /api/admin/cache/clear` - 清除缓存

---

## 2. API模型设计

### 2.1 请求模型

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/model/DocumentRequest.java`

```java
package top.yumbo.ai.rag.api.model;

import lombok.Data;
import java.util.Map;

@Data
public class DocumentRequest {
    private String title;
    private String content;
    private String category;
    private Map<String, Object> metadata;
}
```

### 2.2 响应模型

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/model/ApiResponse.java`

```java
package top.yumbo.ai.rag.api.model;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ApiResponse<T> {
    private boolean success;
    private String message;
    private T data;
    private String error;
    
    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
            .success(true)
            .data(data)
            .build();
    }
    
    public static <T> ApiResponse<T> success(String message, T data) {
        return ApiResponse.<T>builder()
            .success(true)
            .message(message)
            .data(data)
            .build();
    }
    
    public static <T> ApiResponse<T> error(String error) {
        return ApiResponse.<T>builder()
            .success(false)
            .error(error)
            .build();
    }
}
```

---

## 3. HTTP服务器实现

### 3.1 Netty服务器配置

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/server/NettyHttpServer.java`

```java
package top.yumbo.ai.rag.api.server;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.http.HttpObjectAggregator;
import io.netty.handler.codec.http.HttpServerCodec;
import lombok.extern.slf4j.Slf4j;

@Slf4j
public class NettyHttpServer {
    
    private final int port;
    private final HttpRequestHandler requestHandler;
    private EventLoopGroup bossGroup;
    private EventLoopGroup workerGroup;
    private ChannelFuture channelFuture;
    
    public NettyHttpServer(int port, HttpRequestHandler requestHandler) {
        this.port = port;
        this.requestHandler = requestHandler;
    }
    
    public void start() throws Exception {
        bossGroup = new NioEventLoopGroup(1);
        workerGroup = new NioEventLoopGroup();
        
        try {
            ServerBootstrap bootstrap = new ServerBootstrap();
            bootstrap.group(bossGroup, workerGroup)
                .channel(NioServerSocketChannel.class)
                .childHandler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    protected void initChannel(SocketChannel ch) {
                        ch.pipeline()
                            .addLast(new HttpServerCodec())
                            .addLast(new HttpObjectAggregator(65536))
                            .addLast(requestHandler);
                    }
                });
            
            channelFuture = bootstrap.bind(port).sync();
            log.info("HTTP Server started on port {}", port);
            
        } catch (Exception e) {
            log.error("Failed to start HTTP server", e);
            shutdown();
            throw e;
        }
    }
    
    public void shutdown() {
        if (channelFuture != null) {
            channelFuture.channel().close();
        }
        if (workerGroup != null) {
            workerGroup.shutdownGracefully();
        }
        if (bossGroup != null) {
            bossGroup.shutdownGracefully();
        }
        log.info("HTTP Server shutdown");
    }
}
```

### 3.2 HTTP请求处理器

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/server/HttpRequestHandler.java`

```java
package top.yumbo.ai.rag.api.server;

import com.alibaba.fastjson2.JSON;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.handler.codec.http.*;
import lombok.extern.slf4j.Slf4j;
import top.yumbo.ai.rag.api.controller.DocumentController;
import top.yumbo.ai.rag.api.controller.SearchController;
import top.yumbo.ai.rag.api.controller.AdminController;
import top.yumbo.ai.rag.api.model.ApiResponse;

import java.nio.charset.StandardCharsets;

@Slf4j
public class HttpRequestHandler extends SimpleChannelInboundHandler<FullHttpRequest> {
    
    private final DocumentController documentController;
    private final SearchController searchController;
    private final AdminController adminController;
    
    public HttpRequestHandler(DocumentController documentController,
                             SearchController searchController,
                             AdminController adminController) {
        this.documentController = documentController;
        this.searchController = searchController;
        this.adminController = adminController;
    }
    
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest request) {
        String uri = request.uri();
        HttpMethod method = request.method();
        
        log.debug("Received {} request: {}", method, uri);
        
        try {
            Object response = routeRequest(request, uri, method);
            sendJsonResponse(ctx, HttpResponseStatus.OK, response);
            
        } catch (IllegalArgumentException e) {
            log.warn("Bad request: {}", e.getMessage());
            sendJsonResponse(ctx, HttpResponseStatus.BAD_REQUEST, 
                ApiResponse.error(e.getMessage()));
                
        } catch (Exception e) {
            log.error("Error processing request", e);
            sendJsonResponse(ctx, HttpResponseStatus.INTERNAL_SERVER_ERROR,
                ApiResponse.error("Internal server error"));
        }
    }
    
    private Object routeRequest(FullHttpRequest request, String uri, HttpMethod method) {
        // 文档管理端点
        if (uri.startsWith("/api/documents")) {
            return routeDocumentRequest(request, uri, method);
        }
        // 搜索端点
        else if (uri.startsWith("/api/search")) {
            return routeSearchRequest(request, uri, method);
        }
        // 管理端点
        else if (uri.startsWith("/api/admin") || uri.startsWith("/api/health") || uri.startsWith("/api/stats")) {
            return routeAdminRequest(request, uri, method);
        }
        else {
            throw new IllegalArgumentException("Unknown endpoint: " + uri);
        }
    }
    
    private Object routeDocumentRequest(FullHttpRequest request, String uri, HttpMethod method) {
        if (method == HttpMethod.POST && uri.equals("/api/documents")) {
            return documentController.createDocument(getRequestBody(request));
        }
        else if (method == HttpMethod.GET && uri.matches("/api/documents/[^/]+")) {
            String id = extractId(uri);
            return documentController.getDocument(id);
        }
        else if (method == HttpMethod.PUT && uri.matches("/api/documents/[^/]+")) {
            String id = extractId(uri);
            return documentController.updateDocument(id, getRequestBody(request));
        }
        else if (method == HttpMethod.DELETE && uri.matches("/api/documents/[^/]+")) {
            String id = extractId(uri);
            return documentController.deleteDocument(id);
        }
        else if (method == HttpMethod.GET && uri.equals("/api/documents")) {
            return documentController.listDocuments();
        }
        else {
            throw new IllegalArgumentException("Invalid document endpoint");
        }
    }
    
    private Object routeSearchRequest(FullHttpRequest request, String uri, HttpMethod method) {
        if (method == HttpMethod.POST && uri.equals("/api/search")) {
            return searchController.search(getRequestBody(request));
        }
        else if (method == HttpMethod.POST && uri.equals("/api/search/advanced")) {
            return searchController.advancedSearch(getRequestBody(request));
        }
        else {
            throw new IllegalArgumentException("Invalid search endpoint");
        }
    }
    
    private Object routeAdminRequest(FullHttpRequest request, String uri, HttpMethod method) {
        if (method == HttpMethod.GET && uri.equals("/api/health")) {
            return adminController.health();
        }
        else if (method == HttpMethod.GET && uri.equals("/api/stats")) {
            return adminController.stats();
        }
        else if (method == HttpMethod.POST && uri.equals("/api/admin/optimize")) {
            return adminController.optimizeIndex();
        }
        else if (method == HttpMethod.POST && uri.equals("/api/admin/cache/clear")) {
            return adminController.clearCache();
        }
        else {
            throw new IllegalArgumentException("Invalid admin endpoint");
        }
    }
    
    private String getRequestBody(FullHttpRequest request) {
        return request.content().toString(StandardCharsets.UTF_8);
    }
    
    private String extractId(String uri) {
        String[] parts = uri.split("/");
        return parts[parts.length - 1];
    }
    
    private void sendJsonResponse(ChannelHandlerContext ctx, HttpResponseStatus status, Object data) {
        String json = JSON.toJSONString(data);
        byte[] bytes = json.getBytes(StandardCharsets.UTF_8);
        
        FullHttpResponse response = new DefaultFullHttpResponse(
            HttpVersion.HTTP_1_1,
            status,
            Unpooled.wrappedBuffer(bytes)
        );
        
        response.headers()
            .set(HttpHeaderNames.CONTENT_TYPE, "application/json; charset=UTF-8")
            .set(HttpHeaderNames.CONTENT_LENGTH, bytes.length);
        
        ctx.writeAndFlush(response);
    }
    
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        log.error("Exception in channel", cause);
        ctx.close();
    }
}
```

---

## 4. 控制器实现

### 4.1 文档控制器

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/controller/DocumentController.java`

```java
package top.yumbo.ai.rag.api.controller;

import com.alibaba.fastjson2.JSON;
import lombok.extern.slf4j.Slf4j;
import top.yumbo.ai.rag.LocalFileRAG;
import top.yumbo.ai.rag.api.model.ApiResponse;
import top.yumbo.ai.rag.api.model.DocumentRequest;
import top.yumbo.ai.rag.model.Document;
import top.yumbo.ai.rag.util.DocumentUtils;

@Slf4j
public class DocumentController {
    
    private final LocalFileRAG rag;
    
    public DocumentController(LocalFileRAG rag) {
        this.rag = rag;
    }
    
    /**
     * 创建文档
     */
    public ApiResponse<String> createDocument(String requestBody) {
        try {
            DocumentRequest request = JSON.parseObject(requestBody, DocumentRequest.class);
            
            Document doc = DocumentUtils.fromText(request.getTitle(), request.getContent());
            if (request.getCategory() != null) {
                doc.setCategory(request.getCategory());
            }
            if (request.getMetadata() != null) {
                doc.setMetadata(request.getMetadata());
            }
            
            String docId = rag.index(doc);
            rag.commit();
            
            log.info("Document created: {}", docId);
            return ApiResponse.success("Document created successfully", docId);
            
        } catch (Exception e) {
            log.error("Failed to create document", e);
            return ApiResponse.error("Failed to create document: " + e.getMessage());
        }
    }
    
    /**
     * 获取文档
     */
    public ApiResponse<Document> getDocument(String id) {
        try {
            Document doc = rag.getDocument(id);
            if (doc == null) {
                return ApiResponse.error("Document not found: " + id);
            }
            return ApiResponse.success(doc);
            
        } catch (Exception e) {
            log.error("Failed to get document: {}", id, e);
            return ApiResponse.error("Failed to get document: " + e.getMessage());
        }
    }
    
    /**
     * 更新文档
     */
    public ApiResponse<String> updateDocument(String id, String requestBody) {
        try {
            DocumentRequest request = JSON.parseObject(requestBody, DocumentRequest.class);
            
            Document doc = DocumentUtils.fromText(request.getTitle(), request.getContent());
            if (request.getCategory() != null) {
                doc.setCategory(request.getCategory());
            }
            if (request.getMetadata() != null) {
                doc.setMetadata(request.getMetadata());
            }
            
            boolean updated = rag.updateDocument(id, doc);
            if (!updated) {
                return ApiResponse.error("Document not found: " + id);
            }
            
            rag.commit();
            log.info("Document updated: {}", id);
            return ApiResponse.success("Document updated successfully", id);
            
        } catch (Exception e) {
            log.error("Failed to update document: {}", id, e);
            return ApiResponse.error("Failed to update document: " + e.getMessage());
        }
    }
    
    /**
     * 删除文档
     */
    public ApiResponse<String> deleteDocument(String id) {
        try {
            boolean deleted = rag.deleteDocument(id);
            if (!deleted) {
                return ApiResponse.error("Document not found: " + id);
            }
            
            rag.commit();
            log.info("Document deleted: {}", id);
            return ApiResponse.success("Document deleted successfully", id);
            
        } catch (Exception e) {
            log.error("Failed to delete document: {}", id, e);
            return ApiResponse.error("Failed to delete document: " + e.getMessage());
        }
    }
    
    /**
     * 列出文档
     */
    public ApiResponse<Object> listDocuments() {
        try {
            var stats = rag.getStatistics();
            return ApiResponse.success("Total documents: " + stats.getDocumentCount(), stats);
            
        } catch (Exception e) {
            log.error("Failed to list documents", e);
            return ApiResponse.error("Failed to list documents: " + e.getMessage());
        }
    }
}
```

### 4.2 搜索控制器

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/controller/SearchController.java`

```java
package top.yumbo.ai.rag.api.controller;

import com.alibaba.fastjson2.JSON;
import lombok.extern.slf4j.Slf4j;
import top.yumbo.ai.rag.LocalFileRAG;
import top.yumbo.ai.rag.api.model.ApiResponse;
import top.yumbo.ai.rag.model.Query;
import top.yumbo.ai.rag.model.SearchResult;
import top.yumbo.ai.rag.query.QueryRequest;
import top.yumbo.ai.rag.query.impl.AdvancedQueryProcessor;

@Slf4j
public class SearchController {
    
    private final LocalFileRAG rag;
    private final AdvancedQueryProcessor queryProcessor;
    
    public SearchController(LocalFileRAG rag) {
        this.rag = rag;
        this.queryProcessor = new AdvancedQueryProcessor(
            rag.getIndexEngine(), 
            rag.getCacheEngine()
        );
    }
    
    /**
     * 基本搜索
     */
    public ApiResponse<SearchResult> search(String requestBody) {
        try {
            Query query = JSON.parseObject(requestBody, Query.class);
            SearchResult result = rag.search(query);
            
            log.info("Search completed: query='{}', hits={}", 
                query.getQueryText(), result.getTotalHits());
            return ApiResponse.success(result);
            
        } catch (Exception e) {
            log.error("Search failed", e);
            return ApiResponse.error("Search failed: " + e.getMessage());
        }
    }
    
    /**
     * 高级搜索
     */
    public ApiResponse<SearchResult> advancedSearch(String requestBody) {
        try {
            QueryRequest request = JSON.parseObject(requestBody, QueryRequest.class);
            SearchResult result = queryProcessor.process(request);
            
            log.info("Advanced search completed: query='{}', hits={}", 
                request.getQueryText(), result.getTotalHits());
            return ApiResponse.success(result);
            
        } catch (Exception e) {
            log.error("Advanced search failed", e);
            return ApiResponse.error("Advanced search failed: " + e.getMessage());
        }
    }
}
```

### 4.3 管理控制器

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/controller/AdminController.java`

```java
package top.yumbo.ai.rag.api.controller;

import lombok.extern.slf4j.Slf4j;
import top.yumbo.ai.rag.LocalFileRAG;
import top.yumbo.ai.rag.api.model.ApiResponse;
import top.yumbo.ai.rag.query.impl.AdvancedQueryProcessor;

import java.util.HashMap;
import java.util.Map;

@Slf4j
public class AdminController {
    
    private final LocalFileRAG rag;
    private final AdvancedQueryProcessor queryProcessor;
    
    public AdminController(LocalFileRAG rag) {
        this.rag = rag;
        this.queryProcessor = new AdvancedQueryProcessor(
            rag.getIndexEngine(), 
            rag.getCacheEngine()
        );
    }
    
    /**
     * 健康检查
     */
    public ApiResponse<Map<String, Object>> health() {
        Map<String, Object> health = new HashMap<>();
        health.put("status", "UP");
        health.put("timestamp", System.currentTimeMillis());
        return ApiResponse.success(health);
    }
    
    /**
     * 统计信息
     */
    public ApiResponse<Map<String, Object>> stats() {
        try {
            var statistics = rag.getStatistics();
            var cacheStats = queryProcessor.getCacheStatistics();
            
            Map<String, Object> stats = new HashMap<>();
            stats.put("documentCount", statistics.getDocumentCount());
            stats.put("indexedDocumentCount", statistics.getIndexedDocumentCount());
            stats.put("cacheStatistics", cacheStats);
            
            return ApiResponse.success(stats);
            
        } catch (Exception e) {
            log.error("Failed to get stats", e);
            return ApiResponse.error("Failed to get stats: " + e.getMessage());
        }
    }
    
    /**
     * 优化索引
     */
    public ApiResponse<String> optimizeIndex() {
        try {
            rag.optimizeIndex();
            log.info("Index optimized");
            return ApiResponse.success("Index optimized successfully", "OK");
            
        } catch (Exception e) {
            log.error("Failed to optimize index", e);
            return ApiResponse.error("Failed to optimize index: " + e.getMessage());
        }
    }
    
    /**
     * 清除缓存
     */
    public ApiResponse<String> clearCache() {
        try {
            queryProcessor.clearCache();
            log.info("Cache cleared");
            return ApiResponse.success("Cache cleared successfully", "OK");
            
        } catch (Exception e) {
            log.error("Failed to clear cache", e);
            return ApiResponse.error("Failed to clear cache: " + e.getMessage());
        }
    }
}
```

---

## 5. API服务启动器

**文件路径**: `ai-reviewer-base-file-rag/src/main/java/top/yumbo/ai/rag/api/ApiServer.java`

```java
package top.yumbo.ai.rag.api;

import lombok.extern.slf4j.Slf4j;
import top.yumbo.ai.rag.LocalFileRAG;
import top.yumbo.ai.rag.api.controller.AdminController;
import top.yumbo.ai.rag.api.controller.DocumentController;
import top.yumbo.ai.rag.api.controller.SearchController;
import top.yumbo.ai.rag.api.server.HttpRequestHandler;
import top.yumbo.ai.rag.api.server.NettyHttpServer;
import top.yumbo.ai.rag.config.RAGConfiguration;

@Slf4j
public class ApiServer {
    
    private final LocalFileRAG rag;
    private final NettyHttpServer httpServer;
    private final int port;
    
    public ApiServer(LocalFileRAG rag, int port) {
        this.rag = rag;
        this.port = port;
        
        // 创建控制器
        DocumentController documentController = new DocumentController(rag);
        SearchController searchController = new SearchController(rag);
        AdminController adminController = new AdminController(rag);
        
        // 创建请求处理器
        HttpRequestHandler requestHandler = new HttpRequestHandler(
            documentController,
            searchController,
            adminController
        );
        
        // 创建HTTP服务器
        this.httpServer = new NettyHttpServer(port, requestHandler);
    }
    
    /**
     * 启动API服务器
     */
    public void start() throws Exception {
        httpServer.start();
        log.info("API Server started on port {}", port);
    }
    
    /**
     * 停止API服务器
     */
    public void stop() {
        httpServer.shutdown();
        rag.close();
        log.info("API Server stopped");
    }
    
    /**
     * 主方法 - 示例
     */
    public static void main(String[] args) throws Exception {
        // 创建配置
        RAGConfiguration config = RAGConfiguration.builder()
            .storage(RAGConfiguration.StorageConfig.builder()
                .basePath("./data")
                .build())
            .build();
        
        // 创建RAG实例
        LocalFileRAG rag = LocalFileRAG.builder()
            .configuration(config)
            .build();
        
        // 创建并启动API服务器
        ApiServer server = new ApiServer(rag, 8080);
        server.start();
        
        // 添加关闭钩子
        Runtime.getRuntime().addShutdownHook(new Thread(server::stop));
    }
}
```

---

## 6. 第四阶段总结

### 完成情况
- ✅ REST API设计完成
- ✅ Netty HTTP服务器实现
- ✅ 文档CRUD端点
- ✅ 搜索端点
- ✅ 管理端点
- ✅ 错误处理
- ✅ JSON序列化

### API端点清单
#### 文档管理
- POST /api/documents - 创建
- GET /api/documents/{id} - 获取
- PUT /api/documents/{id} - 更新  
- DELETE /api/documents/{id} - 删除
- GET /api/documents - 列表

#### 搜索
- POST /api/search - 基本搜索
- POST /api/search/advanced - 高级搜索

#### 管理
- GET /api/health - 健康检查
- GET /api/stats - 统计信息
- POST /api/admin/optimize - 优化索引
- POST /api/admin/cache/clear - 清除缓存

### 技术特性
1. **Netty异步IO** - 高性能HTTP服务
2. **RESTful设计** - 标准化API
3. **JSON格式** - 使用Fastjson2
4. **统一响应** - ApiResponse封装
5. **错误处理** - 完整的异常处理

---

**文档结束**

**第四阶段设计文档完成时间**: 2025-11-21 22:55:00

