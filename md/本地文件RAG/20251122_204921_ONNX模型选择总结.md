# âœ… ONNX æ¨¡å‹é€‰æ‹©å®Œæˆ

## ğŸ¯ ä½ çš„é—®é¢˜

**é—®é¢˜ï¼š** `paraphrase-multilingual-MiniLM-L12-v2` é‡Œé¢åŒ…å«å¤šä¸ªæ¨¡å‹æ–‡ä»¶ï¼Œåº”è¯¥ç”¨å“ªä¸ªï¼Ÿ

```
model.onnx
model_O1.onnx
model_O2.onnx
model_O3.onnx
model_O4.onnx
model_qint8_arm64.onnx
model_qint8_avx512.onnx
model_qint8_avx512_vnni.onnx
model_quint8_avx2.onnx
```

---

## ğŸ¯ æˆ‘çš„å»ºè®®

### æ¨èæ–¹æ¡ˆ 1: model.onnxï¼ˆâ­â­â­ æœ€æ¨èï¼‰

```
æ–‡ä»¶: model.onnx
å¤§å°: ~280MB
é€Ÿåº¦: åŸºå‡†é€Ÿåº¦
ç²¾åº¦: 100%
å…¼å®¹æ€§: âœ… æ‰€æœ‰å¹³å°é€šç”¨

ä¼˜ç‚¹:
âœ… ç®€å• - ä¸‹è½½å³ç”¨
âœ… ç¨³å®š - å…¼å®¹æ€§æœ€å¥½
âœ… é€šç”¨ - ä¸éœ€è¦æ£€æŸ¥ç¡¬ä»¶
âœ… å¤Ÿç”¨ - å¯¹äºå¤§å¤šæ•°åœºæ™¯æ€§èƒ½è¶³å¤Ÿ

é€‚åˆåœºæ™¯:
- å¼€å‘å’Œæµ‹è¯•
- å¿«é€Ÿä¸Šæ‰‹
- ç¡¬ä»¶ç¯å¢ƒä¸ç¡®å®š
- 95% çš„ä½¿ç”¨åœºæ™¯
```

### æ¨èæ–¹æ¡ˆ 2: model_quint8_avx2.onnxï¼ˆâ­â­ å¦‚æœéœ€è¦é€Ÿåº¦ï¼‰

```
æ–‡ä»¶: model_quint8_avx2.onnx
å¤§å°: ~70MB
é€Ÿåº¦: 2-3å€æå‡
ç²¾åº¦: 99.5%
å…¼å®¹æ€§: âœ… å¤§å¤šæ•°ç°ä»£CPUï¼ˆ2013+ï¼‰

ä¼˜ç‚¹:
âœ… å¿«é€Ÿ - é€Ÿåº¦æå‡ 2-3å€
âœ… çœå†…å­˜ - å¤§å°å‡å°‘ 75%
âœ… å…¼å®¹ - å¤§å¤šæ•° CPU æ”¯æŒ AVX2
âœ… ç²¾åº¦é«˜ - å‡ ä¹æ— æŸ

é€‚åˆåœºæ™¯:
- ç”Ÿäº§ç¯å¢ƒ
- å¤§æ‰¹é‡å¤„ç†
- éœ€è¦ä¼˜åŒ–æ€§èƒ½
- 2013å¹´åçš„ CPU
```

### æ¨èæ–¹æ¡ˆ 3: æ ¹æ®ç¡¬ä»¶é€‰æ‹©ï¼ˆâ­ é«˜çº§ç”¨æˆ·ï¼‰

```
Mac M1/M2:
  ä½¿ç”¨: model_qint8_arm64.onnx
  é€Ÿåº¦: 3-4å€æå‡

Intel æœåŠ¡å™¨ï¼ˆæ”¯æŒ AVX-512 VNNIï¼‰:
  ä½¿ç”¨: model_qint8_avx512_vnni.onnx
  é€Ÿåº¦: 4-5å€æå‡

Intel æœåŠ¡å™¨ï¼ˆæ”¯æŒ AVX-512ï¼‰:
  ä½¿ç”¨: model_qint8_avx512.onnx
  é€Ÿåº¦: 3-4å€æå‡

æ™®é€š CPUï¼ˆæ”¯æŒ AVX2ï¼‰:
  ä½¿ç”¨: model_quint8_avx2.onnx
  é€Ÿåº¦: 2-3å€æå‡
```

---

## âœ… ç³»ç»Ÿå·²è‡ªåŠ¨æ”¯æŒ

æˆ‘å·²ç»æ›´æ–°äº†ä»£ç ï¼Œç³»ç»Ÿç°åœ¨ä¼š**è‡ªåŠ¨æŸ¥æ‰¾å¹¶é€‰æ‹©å¯ç”¨çš„æ¨¡å‹**ï¼š

### æŸ¥æ‰¾ä¼˜å…ˆçº§

```
1. model.onnx                    â† æ ‡å‡†æ¨¡å‹ï¼ˆæ¨èï¼‰
2. model_O2.onnx                 â† ä¼˜åŒ–æ¨¡å‹
3. model_O3.onnx                 â† é«˜çº§ä¼˜åŒ–
4. model_quint8_avx2.onnx        â† AVX2 é‡åŒ–
5. model_qint8_avx512.onnx       â† AVX-512 é‡åŒ–
6. model_qint8_avx512_vnni.onnx  â† VNNI é‡åŒ–
7. model_qint8_arm64.onnx        â† ARM64 é‡åŒ–
```

### ä½ åªéœ€è¦ï¼š

**æ­¥éª¤ 1: ä¸‹è½½ä»»æ„ä¸€ä¸ªæ¨¡å‹æ–‡ä»¶**
```bash
# åªéœ€ä¸‹è½½ model.onnxï¼ˆæ¨èï¼‰
https://huggingface.co/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2/blob/main/model.onnx

# æˆ–è€…ä¸‹è½½ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
# model_quint8_avx2.onnx, model_O2.onnx ç­‰
```

**æ­¥éª¤ 2: æ”¾åˆ°æŒ‡å®šç›®å½•**
```bash
./models/paraphrase-multilingual/
  â””â”€â”€ model.onnx    # æˆ–ä»»ä½•å…¶ä»–ç‰ˆæœ¬
```

**æ­¥éª¤ 3: è¿è¡Œç³»ç»Ÿ**
```bash
# ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰¾åˆ°å¹¶ä½¿ç”¨
.\run-qa-system.ps1
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹ï¼š**
```
âœ… ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ¨¡å‹: model.onnx
   è·¯å¾„: D:\...\models\paraphrase-multilingual\model.onnx
```

---

## ğŸ“Š æ¨¡å‹å¯¹æ¯”è¡¨

| æ¨¡å‹æ–‡ä»¶ | å¤§å° | é€Ÿåº¦ | ç²¾åº¦ | CPUè¦æ±‚ | æ¨èåº¦ |
|---------|------|------|------|---------|--------|
| **model.onnx** | 280MB | 1x | 100% | æ—  | â­â­â­â­â­ |
| model_O2.onnx | 280MB | 1.2x | 100% | æ—  | â­â­â­ |
| model_O3.onnx | 280MB | 1.3x | 100% | æ—  | â­â­ |
| **model_quint8_avx2.onnx** | 70MB | 2-3x | 99.5% | AVX2 | â­â­â­â­ |
| model_qint8_avx512.onnx | 70MB | 3-4x | 99.5% | AVX-512 | â­â­â­ |
| model_qint8_avx512_vnni.onnx | 70MB | 4-5x | 99.5% | VNNI | â­â­â­ |
| model_qint8_arm64.onnx | 70MB | 3-4x | 99.5% | ARM64 | â­â­â­â­ |

---

## ğŸ’¡ å¿«é€Ÿå†³ç­–

### å¦‚æœä½ ä¸ç¡®å®šï¼š
```
ğŸ‘‰ ç›´æ¥ä½¿ç”¨ model.onnx
   - æœ€ç®€å•
   - æœ€ç¨³å®š
   - å…¼å®¹æ€§æœ€å¥½
   - æ€§èƒ½è¶³å¤Ÿ
```

### å¦‚æœä½ éœ€è¦æ€§èƒ½ï¼š
```
ğŸ‘‰ ä½¿ç”¨ model_quint8_avx2.onnx
   - é€Ÿåº¦æå‡ 2-3å€
   - å†…å­˜å‡å°‘ 75%
   - å…¼å®¹å¤§å¤šæ•° CPU
   - ç²¾åº¦æŸå¤±å¯å¿½ç•¥
```

### å¦‚æœä½ ç”¨ Mac M1/M2ï¼š
```
ğŸ‘‰ ä½¿ç”¨ model_qint8_arm64.onnx
   - ä¸“é—¨ä¼˜åŒ–
   - é€Ÿåº¦æå‡ 3-4å€
   - å®Œç¾é€‚é…
```

---

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³• 1: ç›´æ¥ä¸‹è½½ï¼ˆæ¨èï¼‰

1. è®¿é—®: https://huggingface.co/sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2
2. æ‰¾åˆ° `Files and versions` æ ‡ç­¾
3. ä¸‹è½½ `model.onnx`
4. æ”¾åˆ° `./models/paraphrase-multilingual/model.onnx`

### æ–¹æ³• 2: ä½¿ç”¨ Python è„šæœ¬

```python
from optimum.onnxruntime import ORTModelForFeatureExtraction
from transformers import AutoTokenizer

model_name = "sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2"
model = ORTModelForFeatureExtraction.from_pretrained(model_name, export=True)
tokenizer = AutoTokenizer.from_pretrained(model_name)

output_dir = "./models/paraphrase-multilingual"
model.save_pretrained(output_dir)
tokenizer.save_pretrained(output_dir)

print(f"âœ… æ¨¡å‹å·²ä¿å­˜åˆ°: {output_dir}")
```

### æ–¹æ³• 3: é‡å‘½åå…¶ä»–ç‰ˆæœ¬

å¦‚æœä½ ä¸‹è½½äº†ä¼˜åŒ–ç‰ˆæœ¬ï¼ˆå¦‚ `model_quint8_avx2.onnx`ï¼‰ï¼š

```bash
# å¯ä»¥é‡å‘½åä¸º model.onnxï¼ˆæœ€ç®€å•ï¼‰
mv model_quint8_avx2.onnx model.onnx

# æˆ–è€…ä¿æŒåŸåï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨æ‰¾åˆ°ï¼‰
```

---

## âœ… éªŒè¯å®‰è£…

### è¿è¡Œæµ‹è¯•
```bash
cd ai-reviewer-base-file-rag
mvn test-compile exec:java \
  -Dexec.mainClass="top.yumbo.ai.rag.test.EmbeddingEngineFixTest" \
  -Dexec.classpathScope=test
```

### é¢„æœŸè¾“å‡º
```
âœ… ä»æ–‡ä»¶ç³»ç»ŸåŠ è½½æ¨¡å‹: model.onnx
   è·¯å¾„: ./models/paraphrase-multilingual/model.onnx

âœ… åµŒå…¥å¼•æ“åˆå§‹åŒ–æˆåŠŸ
   - æ¨¡å‹: paraphrase-multilingual-MiniLM-L12-v2
   - ç»´åº¦: 384

âœ… åµŒå…¥ç”ŸæˆæˆåŠŸ
   - å‘é‡ç»´åº¦: 384
   - å‘é‡èŒƒæ•°: 1.0
```

---

## ğŸ“– æ›´å¤šä¿¡æ¯

### è¯¦ç»†æ–‡æ¡£
- `ONNXæ¨¡å‹é€‰æ‹©æŒ‡å—.md` - å®Œæ•´çš„é€‰æ‹©æŒ‡å—
- `æ¨¡å‹ä¸‹è½½æŒ‡å—.md` - ä¸‹è½½æ­¥éª¤è¯´æ˜

### æ¨¡å‹è¯´æ˜
- **æ ‡å‡†æ¨¡å‹ (model.onnx)**: FP32ç²¾åº¦ï¼Œå®Œæ•´åŠŸèƒ½
- **ä¼˜åŒ–æ¨¡å‹ (model_O*.onnx)**: å›¾ä¼˜åŒ–ï¼Œæ€§èƒ½æå‡
- **é‡åŒ–æ¨¡å‹ (model_q*.onnx)**: INT8ç²¾åº¦ï¼Œé€Ÿåº¦å¿«ï¼Œå†…å­˜å°

### æ€§èƒ½è€ƒè™‘
- å¯¹äºå¤§å¤šæ•° RAG åº”ç”¨ï¼Œæ ‡å‡†æ¨¡å‹å·²ç»è¶³å¤Ÿå¿«
- å‘é‡åµŒå…¥é€šå¸¸ä¸æ˜¯æ€§èƒ½ç“¶é¢ˆ
- é™¤éå¤„ç†æµ·é‡æ•°æ®ï¼Œå¦åˆ™ä¸éœ€è¦é‡åŒ–æ¨¡å‹

---

## ğŸ‰ æ€»ç»“

### æˆ‘çš„æœ€ç»ˆå»ºè®®

**ä½¿ç”¨ model.onnx** ï¼ˆæ ‡å‡†ç‰ˆæœ¬ï¼‰

**åŸå› ï¼š**
1. âœ… æœ€ç®€å• - ä¸‹è½½å³ç”¨
2. âœ… æœ€ç¨³å®š - å…¼å®¹æ€§æœ€å¥½
3. âœ… å¤Ÿç”¨ - æ€§èƒ½è¶³å¤Ÿå¥½
4. âœ… æ— å¿§ - ä¸éœ€è¦è€ƒè™‘ç¡¬ä»¶

**å¦‚æœä»¥åå‘ç°æ€§èƒ½ä¸è¶³ï¼Œå†è€ƒè™‘åˆ‡æ¢åˆ°é‡åŒ–æ¨¡å‹ã€‚**

### ç³»ç»Ÿå·²æ”¯æŒ

- âœ… è‡ªåŠ¨æŸ¥æ‰¾å¤šç§æ¨¡å‹æ–‡ä»¶
- âœ… ä¼˜å…ˆé€‰æ‹©æ ‡å‡†æ¨¡å‹
- âœ… é™çº§åˆ°å…¶ä»–å¯ç”¨ç‰ˆæœ¬
- âœ… å‹å¥½çš„é”™è¯¯æç¤º

### ä½ åªéœ€è¦

1. ä¸‹è½½ `model.onnx`
2. æ”¾åˆ° `./models/paraphrase-multilingual/`
3. è¿è¡Œç³»ç»Ÿ

å°±è¿™ä¹ˆç®€å•ï¼ğŸ‰

