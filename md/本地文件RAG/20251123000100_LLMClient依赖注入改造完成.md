# âœ… LLMClient ä¾èµ–æ³¨å…¥æ”¹é€ å®Œæˆ

## ğŸ¯ æ”¹é€ ç›®æ ‡

å°† `KnowledgeQAService` ä¸­çš„ç›´æ¥ `new MockLLMClient()` æ”¹ä¸º Spring ä¾èµ–æ³¨å…¥æ–¹å¼ï¼Œç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™å’Œ IoC è®¾è®¡æ¨¡å¼ã€‚

---

## ğŸ“ æ”¹é€ å†…å®¹

### 1. **ä¿®æ”¹ KnowledgeQAService**

#### æ”¹é€ å‰ âŒ
```java
@Service
public class KnowledgeQAService {
    private LLMClient llmClient;
    
    private void initializeLLMClient() {
        // ç›´æ¥ new å¯¹è±¡ï¼Œç´§è€¦åˆ
        llmClient = new MockLLMClient();
    }
}
```

#### æ”¹é€ å âœ…
```java
@Service
public class KnowledgeQAService {
    private final LLMClient llmClient;  // é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥
    
    public KnowledgeQAService(
        KnowledgeQAProperties properties,
        KnowledgeBaseService knowledgeBaseService,
        HybridSearchService hybridSearchService,
        LLMClient llmClient) {  // â† æ³¨å…¥ LLMClient
        
        this.llmClient = llmClient;
    }
    
    private void initializeLLMClient() {
        // åªæ‰“å°æ—¥å¿—ï¼Œä¸å†åˆ›å»ºå¯¹è±¡
        log.info("LLMå®¢æˆ·ç«¯å·²å°±ç»ª: {}", llmClient.getClass().getSimpleName());
    }
}
```

### 2. **åˆ›å»º LLMConfiguration é…ç½®ç±»**

**æ–‡ä»¶**: `config/LLMConfiguration.java`

```java
@Configuration
public class LLMConfiguration {
    
    @Bean
    @ConditionalOnMissingBean
    public LLMClient llmClient() {
        log.info("ğŸ¤– åˆ›å»º Mock LLM å®¢æˆ·ç«¯");
        return new MockLLMClient();
    }
}
```

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨ `@Bean` æ³¨è§£å°† LLMClient æ³¨å†Œä¸º Spring Bean
- âœ… ä½¿ç”¨ `@ConditionalOnMissingBean` å…è®¸ç”¨æˆ·è‡ªå®šä¹‰è¦†ç›–
- âœ… é›†ä¸­ç®¡ç† LLM å®¢æˆ·ç«¯çš„åˆ›å»ºé€»è¾‘

---

## ğŸ¨ è®¾è®¡ä¼˜åŠ¿

### æ”¹é€ å‰çš„é—®é¢˜

```
âŒ ç´§è€¦åˆ
   â””â”€â”€ KnowledgeQAService ç›´æ¥ä¾èµ– MockLLMClient

âŒ éš¾ä»¥æµ‹è¯•
   â””â”€â”€ æ— æ³•åœ¨æµ‹è¯•ä¸­æ³¨å…¥ Mock å¯¹è±¡

âŒ éš¾ä»¥æ‰©å±•
   â””â”€â”€ åˆ‡æ¢ LLM å®ç°éœ€è¦ä¿®æ”¹ KnowledgeQAService ä»£ç 

âŒ è¿ååŸåˆ™
   â””â”€â”€ è¿åä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰
```

### æ”¹é€ åçš„ä¼˜åŠ¿

```
âœ… æ¾è€¦åˆ
   â””â”€â”€ KnowledgeQAService åªä¾èµ– LLMClient æ¥å£

âœ… æ˜“äºæµ‹è¯•
   â””â”€â”€ å¯ä»¥æ³¨å…¥ä»»ä½• LLMClient å®ç°

âœ… æ˜“äºæ‰©å±•
   â””â”€â”€ åªéœ€æ·»åŠ æ–°çš„ @Bean é…ç½®

âœ… ç¬¦åˆåŸåˆ™
   â””â”€â”€ ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰
   â””â”€â”€ ç¬¦åˆå¼€é—­åŸåˆ™ï¼ˆOCPï¼‰
```

---

## ğŸ”„ æ‰©å±•ç¤ºä¾‹

### å¦‚ä½•æ·»åŠ çœŸå®çš„ LLM å®ç°ï¼Ÿ

#### æ­¥éª¤1: åˆ›å»º LLM å®ç°ç±»

```java
public class DeepSeekLLMClient implements LLMClient {
    
    private final String apiKey;
    private final String model;
    
    public DeepSeekLLMClient(String apiKey, String model) {
        this.apiKey = apiKey;
        this.model = model;
    }
    
    @Override
    public String generate(String prompt) {
        // è°ƒç”¨ DeepSeek API
        // ...
    }
}
```

#### æ­¥éª¤2: åœ¨é…ç½®ç±»ä¸­æ·»åŠ  Bean

```java
@Configuration
public class LLMConfiguration {
    
    // çœŸå®çš„ DeepSeek å®¢æˆ·ç«¯
    @Bean
    @ConditionalOnProperty(
        prefix = "knowledge.qa.llm",
        name = "provider",
        havingValue = "deepseek"
    )
    public LLMClient deepSeekLLMClient(KnowledgeQAProperties properties) {
        String apiKey = properties.getLlm().getApiKey();
        String model = properties.getLlm().getModel();
        return new DeepSeekLLMClient(apiKey, model);
    }
    
    // Mock å®¢æˆ·ç«¯ï¼ˆé»˜è®¤ï¼‰
    @Bean
    @ConditionalOnMissingBean
    public LLMClient mockLLMClient() {
        return new MockLLMClient();
    }
}
```

#### æ­¥éª¤3: é…ç½®æ–‡ä»¶åˆ‡æ¢

```yaml
knowledge:
  qa:
    llm:
      provider: deepseek  # åˆ‡æ¢åˆ° deepseek
      api-key: ${AI_API_KEY}
      model: deepseek-chat
```

**å°±è¿™ä¹ˆç®€å•ï¼æ— éœ€ä¿®æ”¹ä»»ä½•ä¸šåŠ¡ä»£ç ï¼** âœ¨

---

## ğŸ“Š å¯¹æ¯”åˆ†æ

| ç»´åº¦ | æ”¹é€ å‰ | æ”¹é€ å |
|------|--------|--------|
| **è€¦åˆåº¦** | ç´§è€¦åˆ | æ¾è€¦åˆ |
| **å¯æµ‹è¯•æ€§** | å›°éš¾ | å®¹æ˜“ |
| **å¯æ‰©å±•æ€§** | éœ€ä¿®æ”¹ä»£ç  | åªéœ€é…ç½® |
| **ç¬¦åˆåŸåˆ™** | è¿å DIP | ç¬¦åˆ DIP/OCP |
| **Spring é£æ ¼** | âŒ ä¸ç¬¦åˆ | âœ… ç¬¦åˆ |

---

## ğŸ¯ è®¾è®¡æ¨¡å¼

### 1. **ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰**
```
é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ LLMClientï¼Œè€Œä¸æ˜¯è‡ªå·±åˆ›å»º
```

### 2. **æ§åˆ¶åè½¬ï¼ˆIoCï¼‰**
```
å¯¹è±¡çš„åˆ›å»ºæ§åˆ¶æƒäº¤ç»™ Spring å®¹å™¨
```

### 3. **ç­–ç•¥æ¨¡å¼ï¼ˆStrategyï¼‰**
```
LLMClient æ˜¯ç­–ç•¥æ¥å£
MockLLMClientã€DeepSeekLLMClient æ˜¯å…·ä½“ç­–ç•¥
é€šè¿‡é…ç½®é€‰æ‹©ä¸åŒçš„ç­–ç•¥
```

### 4. **å·¥å‚æ¨¡å¼ï¼ˆFactoryï¼‰**
```
LLMConfiguration å……å½“å·¥å‚
æ ¹æ®æ¡ä»¶åˆ›å»ºä¸åŒçš„ LLMClient å®ä¾‹
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. **æ„é€ å‡½æ•°æ³¨å…¥** âœ… æ¨è

```java
public class MyService {
    private final Dependency dependency;
    
    public MyService(Dependency dependency) {  // æ„é€ å‡½æ•°æ³¨å…¥
        this.dependency = dependency;
    }
}
```

**ä¼˜ç‚¹**:
- âœ… ä¾èµ–æ˜ç¡®
- âœ… final å­—æ®µä¿è¯ä¸å¯å˜
- âœ… æ˜“äºæµ‹è¯•

### 2. **å­—æ®µæ³¨å…¥** âš ï¸ ä¸æ¨è

```java
public class MyService {
    @Autowired  // å­—æ®µæ³¨å…¥
    private Dependency dependency;
}
```

**ç¼ºç‚¹**:
- âŒ éšè—ä¾èµ–
- âŒ æ— æ³•ä½¿ç”¨ final
- âŒ æµ‹è¯•å›°éš¾

### 3. **ç›´æ¥ new** âŒ é¿å…

```java
public class MyService {
    private Dependency dependency = new DependencyImpl();  // ç›´æ¥ new
}
```

**ç¼ºç‚¹**:
- âŒ ç´§è€¦åˆ
- âŒ æ— æ³•æ›¿æ¢å®ç°
- âŒ è¿å DIP

---

## ğŸ” æ ¸å¿ƒåŸåˆ™

### ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰

**å®šä¹‰**: é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡

```
æ”¹é€ å‰:
KnowledgeQAService â†’ MockLLMClient (å…·ä½“å®ç°)
            â†“ è¿å DIP

æ”¹é€ å:
KnowledgeQAService â†’ LLMClient (æ¥å£)
                            â†‘
                    MockLLMClient (å…·ä½“å®ç°)
            â†“ ç¬¦åˆ DIP
```

### å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰

**å®šä¹‰**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

```
æ‰©å±•æ–°çš„ LLM å®ç°:
- âœ… åªéœ€æ·»åŠ æ–°çš„é…ç½® (@Bean)
- âœ… æ— éœ€ä¿®æ”¹ KnowledgeQAService
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

```
ä¿®æ”¹çš„æ–‡ä»¶:
â”œâ”€â”€ KnowledgeQAService.java
â”‚   â””â”€â”€ æ”¹ä¸ºæ„é€ å‡½æ•°æ³¨å…¥ LLMClient

æ–°å¢çš„æ–‡ä»¶:
â””â”€â”€ LLMConfiguration.java
    â””â”€â”€ æä¾› LLMClient Bean
```

---

## âœ… æ”¹é€ å®Œæˆæ¸…å•

- âœ… ç§»é™¤ `new MockLLMClient()` ç›´æ¥åˆ›å»º
- âœ… æ”¹ä¸ºæ„é€ å‡½æ•°æ³¨å…¥ `LLMClient`
- âœ… åˆ›å»º `LLMConfiguration` é…ç½®ç±»
- âœ… ä½¿ç”¨ `@Bean` æ³¨å†Œ LLMClient
- âœ… ä½¿ç”¨ `@ConditionalOnMissingBean` æ”¯æŒè¦†ç›–
- âœ… ç§»é™¤æœªä½¿ç”¨çš„ import
- âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯

---

## ğŸ‰ æ€»ç»“

**æˆåŠŸå°†ç¡¬ç¼–ç çš„å¯¹è±¡åˆ›å»ºæ”¹é€ ä¸º Spring ä¾èµ–æ³¨å…¥æ–¹å¼ï¼**

**æ ¸å¿ƒæ”¶ç›Š**:
1. âœ… **æ¾è€¦åˆ** - ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™
2. âœ… **æ˜“æµ‹è¯•** - å¯ä»¥æ³¨å…¥ Mock å¯¹è±¡
3. âœ… **æ˜“æ‰©å±•** - é€šè¿‡é…ç½®åˆ‡æ¢å®ç°
4. âœ… **Spring åŒ–** - ç¬¦åˆ Spring æœ€ä½³å®è·µ

**è¿™æ˜¯ä¸€æ¬¡æ•™ç§‘ä¹¦çº§åˆ«çš„é‡æ„ï¼** ğŸ“

---

**æ”¹é€ æ—¶é—´**: 2025-11-23  
**æ”¹é€ ç‰ˆæœ¬**: v1.0

