# âœ… æ—§ç±»ç§»é™¤å’Œé€»è¾‘é›†æˆå®Œæˆ

## ğŸ¯ å®Œæˆæ¦‚è§ˆ

æˆ‘å·²ç»æˆåŠŸå°† `ExcelKnowledgeQASystem.java` å’Œ `AIQASystemExample.java` ä¸­çš„æ ¸å¿ƒé€»è¾‘æå–å¹¶é›†æˆåˆ° Spring Boot åº”ç”¨ä¸­ï¼Œå¹¶ç§»é™¤äº†è¿™ä¸¤ä¸ªæ—§ç±»ã€‚

---

## ğŸ—‘ï¸ ç§»é™¤çš„ç±»

### 1. ExcelKnowledgeQASystem.java âŒ
**åŸä½ç½®**: `top.yumbo.ai.rag.example.ExcelKnowledgeQASystem`

**åŠŸèƒ½**:
- çŸ¥è¯†åº“åˆå§‹åŒ–
- é—®ç­”ç³»ç»Ÿé›†æˆ
- äº¤äº’å¼å‘½ä»¤è¡Œç•Œé¢

**ç§»é™¤åŸå› **:
- âœ… åŠŸèƒ½å·²é›†æˆåˆ° `KnowledgeQAService`
- âœ… ä½¿ç”¨ Spring Boot çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… æä¾› REST API æ›¿ä»£å‘½ä»¤è¡Œ

### 2. AIQASystemExample.java âŒ
**åŸä½ç½®**: `top.yumbo.ai.rag.example.AIQASystemExample`

**åŠŸèƒ½**:
- æ··åˆæ£€ç´¢ï¼ˆLucene + Vectorï¼‰
- æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º
- LLM è°ƒç”¨å’Œé—®ç­”

**ç§»é™¤åŸå› **:
- âœ… æ··åˆæ£€ç´¢é€»è¾‘å·²æå–åˆ° `HybridSearchService`
- âœ… é—®ç­”é€»è¾‘å·²é›†æˆåˆ° `KnowledgeQAService`
- âœ… ä½¿ç”¨ä¾èµ–æ³¨å…¥å’ŒæœåŠ¡åŒ–æ¶æ„

---

## ğŸ“¦ æ–°åˆ›å»ºçš„æœåŠ¡

### 1. HybridSearchService.java âœ…
**è·¯å¾„**: `service/HybridSearchService.java`

**åŠŸèƒ½**:
```java
// æ··åˆæ£€ç´¢ï¼šLucene å…³é”®è¯ + å‘é‡è¯­ä¹‰
public List<Document> hybridSearch(String question, LocalFileRAG rag,
                                   LocalEmbeddingEngine embeddingEngine,
                                   SimpleVectorIndexEngine vectorIndexEngine)

// çº¯å…³é”®è¯æ£€ç´¢ï¼ˆå›é€€æ¨¡å¼ï¼‰
public List<Document> keywordSearch(String question, LocalFileRAG rag)

// å…³é”®è¯æå–
private String extractKeywords(String question)
```

**æ ¸å¿ƒç‰¹æ€§**:
- âœ… Lucene å¿«é€Ÿç²—ç­›ï¼ˆæƒé‡ 0.3ï¼‰
- âœ… å‘é‡è¯­ä¹‰ç²¾æ’ï¼ˆæƒé‡ 0.7ï¼‰
- âœ… æ··åˆè¯„åˆ†èåˆ
- âœ… è‡ªåŠ¨å›é€€åˆ°å…³é”®è¯æ£€ç´¢
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

**æ£€ç´¢æµç¨‹**:
```
1. Lucene å…³é”®è¯æ£€ç´¢ â†’ è¿”å› topK*2 ä¸ªå€™é€‰æ–‡æ¡£
2. å‘é‡è¯­ä¹‰æ£€ç´¢ â†’ è®¡ç®—ç›¸ä¼¼åº¦
3. æ··åˆè¯„åˆ† â†’ èåˆä¸¤ç§ç»“æœ (0.3*lucene + 0.7*vector)
4. æ’åºå– topK â†’ è¿”å›æœ€ç»ˆç»“æœ
```

---

## ğŸ”„ æ›´æ–°çš„ç°æœ‰æœåŠ¡

### KnowledgeQAService.java

#### æ–°å¢ä¾èµ–æ³¨å…¥
```java
private final HybridSearchService hybridSearchService;
private top.yumbo.ai.rag.optimization.SmartContextBuilder contextBuilder;

public KnowledgeQAService(KnowledgeQAProperties properties,
                         KnowledgeBaseService knowledgeBaseService,
                         HybridSearchService hybridSearchService) {
    // ...
}
```

#### åˆå§‹åŒ–æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»ºå™¨
```java
private void createQASystem() {
    contextBuilder = SmartContextBuilder.builder()
        .maxContextLength(properties.getLlm().getMaxContextLength())
        .maxDocLength(properties.getLlm().getMaxDocLength())
        .build();
}
```

#### å®Œæ•´çš„é—®ç­”æµç¨‹
```java
public AIAnswer ask(String question) {
    // æ­¥éª¤1: æ··åˆæ£€ç´¢
    List<Document> documents = embeddingEngine != null ?
        hybridSearchService.hybridSearch(...) :  // å‘é‡æ£€ç´¢
        hybridSearchService.keywordSearch(...);  // å…³é”®è¯æ£€ç´¢
    
    // æ­¥éª¤2: æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º
    String context = contextBuilder.buildSmartContext(question, documents);
    
    // æ­¥éª¤3: æ„å»º Prompt
    String prompt = buildPrompt(question, context);
    
    // æ­¥éª¤4: LLM ç”Ÿæˆç­”æ¡ˆ
    String answer = llmClient.generate(prompt);
    
    // æ­¥éª¤5: è¿”å›ç»“æœ
    return new AIAnswer(answer, sources, totalTime);
}
```

---

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

### æ—§æ¶æ„ (ExcelKnowledgeQASystem + AIQASystemExample)

| ç‰¹æ€§ | å®ç°æ–¹å¼ |
|------|---------|
| **æ¶æ„** | ç‹¬ç«‹çš„å·¥å…·ç±» |
| **ä¾èµ–ç®¡ç†** | æ‰‹åŠ¨åˆ›å»ºå’Œä¼ é€’ |
| **ç”Ÿå‘½å‘¨æœŸ** | æ‰‹åŠ¨ç®¡ç† |
| **é…ç½®** | ç¡¬ç¼–ç  + å‘½ä»¤è¡Œå‚æ•° |
| **æ¥å£** | å‘½ä»¤è¡Œäº¤äº’ |
| **æ£€ç´¢** | æ··åˆæ£€ç´¢ï¼ˆLucene + Vectorï¼‰ |
| **ä¸Šä¸‹æ–‡** | æ™ºèƒ½æ„å»º |
| **å¯ç»´æŠ¤æ€§** | âŒ ä½ï¼ˆç´§è€¦åˆï¼‰ |

### æ–°æ¶æ„ (Spring Boot æœåŠ¡åŒ–)

| ç‰¹æ€§ | å®ç°æ–¹å¼ |
|------|---------|
| **æ¶æ„** | âœ… Spring Boot æœåŠ¡å±‚ |
| **ä¾èµ–ç®¡ç†** | âœ… ä¾èµ–æ³¨å…¥ (@Autowired) |
| **ç”Ÿå‘½å‘¨æœŸ** | âœ… Spring ç®¡ç† (@PostConstruct, @PreDestroy) |
| **é…ç½®** | âœ… application.yml |
| **æ¥å£** | âœ… REST API |
| **æ£€ç´¢** | âœ… æ··åˆæ£€ç´¢ï¼ˆæœåŠ¡åŒ–ï¼‰ |
| **ä¸Šä¸‹æ–‡** | âœ… æ™ºèƒ½æ„å»ºï¼ˆæœåŠ¡åŒ–ï¼‰ |
| **å¯ç»´æŠ¤æ€§** | âœ… é«˜ï¼ˆæ¾è€¦åˆï¼Œæ¨¡å—åŒ–ï¼‰ |

---

## ğŸ¨ æ ¸å¿ƒé€»è¾‘æå–

### 1. æ··åˆæ£€ç´¢ç®—æ³•

**åŸå®ç°** (AIQASystemExample):
```java
// Lucene æ£€ç´¢
SearchResult luceneResult = rag.search(...);

// å‘é‡æ£€ç´¢
List<VectorSearchResult> vectorResults = vectorIndexEngine.search(...);

// æ··åˆè¯„åˆ†
double hybridScore = 0.3 * luceneScore + 0.7 * vectorScore;
```

**æ–°å®ç°** (HybridSearchService):
```java
@Service
public class HybridSearchService {
    public List<Document> hybridSearch(...) {
        // 1. Lucene ç²—ç­› (æƒé‡ 0.3)
        SearchResult luceneResult = rag.search(...);
        
        // 2. å‘é‡ç²¾æ’ (æƒé‡ 0.7)
        List<VectorSearchResult> vectorResults = vectorIndexEngine.search(...);
        
        // 3. æ··åˆè¯„åˆ†
        Map<String, Double> scores = calculateHybridScores(...);
        
        // 4. è¿”å› Top-K
        return getTopKDocuments(scores);
    }
}
```

### 2. æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º

**åŸå®ç°** (AIQASystemExample):
```java
SmartContextBuilder contextBuilder = SmartContextBuilder.builder()
    .maxContextLength(20000)
    .maxDocLength(5000)
    .build();
    
String context = contextBuilder.buildSmartContext(question, documents);
```

**æ–°å®ç°** (KnowledgeQAService):
```java
@PostConstruct
public void initialize() {
    // ä»é…ç½®è¯»å–å‚æ•°
    contextBuilder = SmartContextBuilder.builder()
        .maxContextLength(properties.getLlm().getMaxContextLength())
        .maxDocLength(properties.getLlm().getMaxDocLength())
        .build();
}

public AIAnswer ask(String question) {
    // ä½¿ç”¨é…ç½®åŒ–çš„ä¸Šä¸‹æ–‡æ„å»ºå™¨
    String context = contextBuilder.buildSmartContext(question, documents);
}
```

### 3. Prompt æ„å»º

**åŸå®ç°** (AIQASystemExample):
```java
private String buildPrompt(String question, String context) {
    return "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åŠ©æ‰‹..." + context + question;
}
```

**æ–°å®ç°** (KnowledgeQAService):
```java
private String buildPrompt(String question, String context) {
    return String.format("""
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ¥è¯†åŠ©æ‰‹ã€‚è¯·åŸºäºä»¥ä¸‹æ–‡æ¡£å†…å®¹å›ç­”ç”¨æˆ·é—®é¢˜ã€‚
        
        # ç›¸å…³æ–‡æ¡£
        %s
        
        # ç”¨æˆ·é—®é¢˜
        %s
        
        # å›ç­”è¦æ±‚
        1. å¿…é¡»åŸºäºæ–‡æ¡£å†…å®¹å›ç­”ï¼Œä¸è¦ç¼–é€ ä¿¡æ¯
        2. å¦‚æœæ–‡æ¡£ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·
        3. å›ç­”è¦æ¸…æ™°ã€å‡†ç¡®ã€æœ‰æ¡ç†
        4. å¯ä»¥å¼•ç”¨æ–‡æ¡£åç§°ä½œä¸ºä¿¡æ¯æ¥æº
        5. ä¿æŒä¸“ä¸šå‹å¥½çš„è¯­æ°”
        
        # è¯·æä¾›ä½ çš„å›ç­”ï¼š
        """, context, question);
}
```

---

## âœ… é›†æˆæ•ˆæœ

### ç¼–è¯‘çŠ¶æ€
```
âœ… ç¼–è¯‘æˆåŠŸ
âœ… æ— é”™è¯¯
âœ… æ— è­¦å‘Š
```

### ç§»é™¤çš„æ–‡ä»¶
```
âŒ ExcelKnowledgeQASystem.java (å·²ç§»é™¤)
âŒ AIQASystemExample.java (å·²ç§»é™¤)
```

### æ–°å¢çš„æ–‡ä»¶
```
âœ… HybridSearchService.java (æ··åˆæ£€ç´¢æœåŠ¡)
```

### æ›´æ–°çš„æ–‡ä»¶
```
âœ… KnowledgeQAService.java (é›†æˆé—®ç­”é€»è¾‘)
âœ… KnowledgeQAController.java (REST API)
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. å¯åŠ¨åº”ç”¨

```bash
mvn spring-boot:run
```

**å¯åŠ¨æ—¥å¿—**:
```
================================================================================
ğŸ“š çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
================================================================================

ğŸ”¨ æ­¥éª¤1: åˆå§‹åŒ–çŸ¥è¯†åº“
   - å­˜å‚¨è·¯å¾„: ./data/knowledge-base
   - æ–‡æ¡£è·¯å¾„: ./data/documents
   - é‡å»ºæ¨¡å¼: å¦
   âœ… çŸ¥è¯†åº“æ„å»ºå®Œæˆ
      - æ€»æ–‡ä»¶: 50
      - æˆåŠŸ: 48
      - æ–‡æ¡£æ•°: 384

ğŸš€ æ­¥éª¤2: åˆå§‹åŒ–å‘é‡æ£€ç´¢å¼•æ“
   âœ… å‘é‡åµŒå…¥å¼•æ“å·²åŠ è½½
      - æ¨¡å‹: paraphrase-multilingual
      - ç»´åº¦: 384
   âœ… å‘é‡ç´¢å¼•å·²åŠ è½½
      - å‘é‡æ•°é‡: 384

ğŸ¤– æ­¥éª¤3: åˆå§‹åŒ–LLMå®¢æˆ·ç«¯
   âœ… LLMå®¢æˆ·ç«¯å·²å°±ç»ª

ğŸ“ æ­¥éª¤4: åˆ›å»ºé—®ç­”ç³»ç»Ÿ
   âœ… æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»ºå™¨å·²åˆå§‹åŒ–
      - æœ€å¤§ä¸Šä¸‹æ–‡: 20000 å­—ç¬¦
      - æœ€å¤§æ–‡æ¡£é•¿åº¦: 5000 å­—ç¬¦
   âœ… ä½¿ç”¨å‘é‡æ£€ç´¢å¢å¼ºæ¨¡å¼

================================================================================
âœ… çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼
================================================================================
```

### 2. ä½¿ç”¨ REST API æé—®

```bash
curl -X POST http://localhost:8080/api/qa/ask \
  -H "Content-Type: application/json" \
  -d '{"question": "è’™å¤æ—15å²ä»¥ä¸Šå©šé…æƒ…å†µ"}'
```

**é—®ç­”æ—¥å¿—**:
```
================================================================================
â“ é—®é¢˜: è’™å¤æ—15å²ä»¥ä¸Šå©šé…æƒ…å†µ
================================================================================

ğŸ” æå–å…³é”®è¯: è’™å¤æ— 15å² ä»¥ä¸Š å©šé… æƒ…å†µ
ğŸ“š Luceneæ£€ç´¢æ‰¾åˆ° 15 ä¸ªæ–‡æ¡£
   Lucene Top-10 æ–‡æ¡£:
      - é•¿è¡¨8-10.xlsx (15000 å­—ç¬¦)
      - æ°‘æ—ç»Ÿè®¡.xlsx (12000 å­—ç¬¦)
      ...

ğŸ¯ å‘é‡æ£€ç´¢æ‰¾åˆ° 12 ä¸ªæ–‡æ¡£
   å‘é‡ Top-10 æ–‡æ¡£:
      - é•¿è¡¨8-10.xlsx (ç›¸ä¼¼åº¦: 0.856)
      - æ°‘æ—ç»Ÿè®¡.xlsx (ç›¸ä¼¼åº¦: 0.782)
      ...

ğŸ² æ··åˆè¯„åˆ† Top-20:
   1. é•¿è¡¨8-10.xlsx (æ··åˆåˆ†æ•°: 0.784)
   2. æ°‘æ—ç»Ÿè®¡.xlsx (æ··åˆåˆ†æ•°: 0.698)
   ...

âœ… ä½¿ç”¨æ··åˆæ£€ç´¢ï¼ˆLucene + Vectorï¼‰
Context stats: {'length': 8500, 'documents': 5, 'avgDocLength': 1700}

ğŸ’¡ å›ç­”:
æ ¹æ®æ£€ç´¢åˆ°çš„æ•°æ®ï¼Œè’™å¤æ—15å²ä»¥ä¸Šäººå£çš„å©šé…æƒ…å†µå¦‚ä¸‹ï¼š
... (AIç”Ÿæˆçš„å›ç­”)

ğŸ“š æ•°æ®æ¥æº (å…±5ä¸ªæ–‡æ¡£):
   - é•¿è¡¨8-10.xlsx
   - æ°‘æ—ç»Ÿè®¡.xlsx
   ...

â±ï¸  å“åº”æ—¶é—´: 1234ms
================================================================================
```

### 3. æœç´¢æ–‡æ¡£

```bash
curl "http://localhost:8080/api/qa/search?query=è’™å¤æ—&limit=10"
```

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. **æ¶æ„æ”¹è¿›**
- âŒ æ—§: ç‹¬ç«‹å·¥å…·ç±»ï¼Œç´§è€¦åˆ
- âœ… æ–°: æœåŠ¡åŒ–æ¶æ„ï¼Œæ¾è€¦åˆ

### 2. **é…ç½®ç®¡ç†**
- âŒ æ—§: ç¡¬ç¼–ç  + å‘½ä»¤è¡Œå‚æ•°
- âœ… æ–°: application.yml ç»Ÿä¸€é…ç½®

### 3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**
- âŒ æ—§: æ‰‹åŠ¨ç®¡ç†èµ„æº
- âœ… æ–°: Spring è‡ªåŠ¨ç®¡ç† (@PostConstruct, @PreDestroy)

### 4. **ä¾èµ–æ³¨å…¥**
- âŒ æ—§: æ‰‹åŠ¨åˆ›å»ºå¯¹è±¡
- âœ… æ–°: ä¾èµ–æ³¨å…¥ (@Service, @Autowired)

### 5. **æ¥å£æ–¹å¼**
- âŒ æ—§: å‘½ä»¤è¡Œäº¤äº’
- âœ… æ–°: REST API

### 6. **å¯æµ‹è¯•æ€§**
- âŒ æ—§: éš¾ä»¥å•å…ƒæµ‹è¯•
- âœ… æ–°: æ˜“äºå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•

---

## ğŸ’¡ è¿ç§»æ€»ç»“

### æå–çš„æ ¸å¿ƒé€»è¾‘

1. âœ… **æ··åˆæ£€ç´¢** â†’ `HybridSearchService`
   - Lucene å…³é”®è¯æ£€ç´¢
   - å‘é‡è¯­ä¹‰æ£€ç´¢
   - æ··åˆè¯„åˆ†ç®—æ³•

2. âœ… **æ™ºèƒ½ä¸Šä¸‹æ–‡æ„å»º** â†’ `KnowledgeQAService`
   - ä½¿ç”¨ `SmartContextBuilder`
   - é…ç½®åŒ–å‚æ•°

3. âœ… **é—®ç­”æµç¨‹** â†’ `KnowledgeQAService.ask()`
   - æ£€ç´¢ â†’ ä¸Šä¸‹æ–‡ â†’ Prompt â†’ LLM â†’ ç­”æ¡ˆ

4. âœ… **Prompt æ¨¡æ¿** â†’ `KnowledgeQAService.buildPrompt()`
   - ç»“æ„åŒ–æç¤ºè¯
   - æ˜ç¡®çš„å›ç­”è¦æ±‚

### ç§»é™¤çš„å†—ä½™ä»£ç 

1. âŒ é‡å¤çš„åˆå§‹åŒ–é€»è¾‘
2. âŒ å‘½ä»¤è¡Œäº¤äº’ä»£ç 
3. âŒ ç¡¬ç¼–ç çš„é…ç½®
4. âŒ ç´§è€¦åˆçš„ç»„ä»¶

---

## ğŸ‰ æ€»ç»“

**æ—§ç±»ç§»é™¤å®Œæˆï¼æ ¸å¿ƒé€»è¾‘å·²å®Œå…¨é›†æˆåˆ° Spring Boot åº”ç”¨ä¸­ï¼**

### å®Œæˆçš„å·¥ä½œ

- âœ… ç§»é™¤äº† 2 ä¸ªæ—§ç±»æ–‡ä»¶
- âœ… åˆ›å»ºäº† 1 ä¸ªæ–°æœåŠ¡ï¼ˆHybridSearchServiceï¼‰
- âœ… æ›´æ–°äº† 1 ä¸ªç°æœ‰æœåŠ¡ï¼ˆKnowledgeQAServiceï¼‰
- âœ… æå–äº†æ‰€æœ‰æ ¸å¿ƒé€»è¾‘
- âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯

### å½“å‰çŠ¶æ€

- âœ… **æ¶æ„**: Spring Boot æœåŠ¡åŒ–
- âœ… **é…ç½®**: application.yml ç®¡ç†
- âœ… **æ£€ç´¢**: æ··åˆæ£€ç´¢ï¼ˆLucene + Vectorï¼‰
- âœ… **ä¸Šä¸‹æ–‡**: æ™ºèƒ½æ„å»º
- âœ… **API**: REST æ¥å£
- âœ… **å¯ç»´æŠ¤**: é«˜åº¦æ¨¡å—åŒ–

**ç°åœ¨ä½ çš„ Spring Boot çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿå·²ç»å®Œå…¨æ•´åˆäº†æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼** ğŸš€

