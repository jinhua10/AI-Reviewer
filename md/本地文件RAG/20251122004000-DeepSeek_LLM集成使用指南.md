# DeepSeek LLMé›†æˆä½¿ç”¨æŒ‡å—

**åˆ›å»ºæ—¶é—´**: 2025-11-22 00:40:00  
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ  
**APIæä¾›å•†**: DeepSeek (OpenAIå…¼å®¹æ¥å£)

---

## ğŸ“‹ æ¦‚è¿°

`MockLLMClient` ç°å·²å®ç°ä¸ºçœŸå®çš„DeepSeek APIå®¢æˆ·ç«¯ï¼Œæ”¯æŒï¼š
- âœ… ä»ç¯å¢ƒå˜é‡è‡ªåŠ¨è¯»å–API Key
- âœ… OpenAIå…¼å®¹çš„APIæ¥å£
- âœ… è‡ªåŠ¨é‡è¯•å’Œé™çº§ï¼ˆæ— API Keyæ—¶ä½¿ç”¨Mockæ¨¡å¼ï¼‰
- âœ… Tokenä½¿ç”¨ç»Ÿè®¡
- âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šè·å–DeepSeek API Key

1. è®¿é—® [DeepSeekå¼€æ”¾å¹³å°](https://platform.deepseek.com/)
2. æ³¨å†Œè´¦å·å¹¶ç™»å½•
3. åœ¨æ§åˆ¶å°åˆ›å»ºAPI Key
4. å¤åˆ¶æ‚¨çš„API Keyï¼ˆæ ¼å¼ï¼š`sk-xxxxxx`ï¼‰

### æ­¥éª¤2ï¼šè®¾ç½®ç¯å¢ƒå˜é‡

#### Windows (PowerShell)
```powershell
# ä¸´æ—¶è®¾ç½®ï¼ˆå½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
$env:AI_API_KEY="sk-your-deepseek-api-key"

# æ°¸ä¹…è®¾ç½®ï¼ˆç³»ç»Ÿç¯å¢ƒå˜é‡ï¼‰
[System.Environment]::SetEnvironmentVariable("AI_API_KEY", "sk-your-deepseek-api-key", "User")
```

#### Windows (CMD)
```cmd
# ä¸´æ—¶è®¾ç½®
set AI_API_KEY=sk-your-deepseek-api-key

# æ°¸ä¹…è®¾ç½®
setx AI_API_KEY "sk-your-deepseek-api-key"
```

#### Linux / macOS
```bash
# ä¸´æ—¶è®¾ç½®ï¼ˆå½“å‰ç»ˆç«¯æœ‰æ•ˆï¼‰
export AI_API_KEY="sk-your-deepseek-api-key"

# æ°¸ä¹…è®¾ç½®ï¼ˆæ·»åŠ åˆ° ~/.bashrc æˆ– ~/.zshrcï¼‰
echo 'export AI_API_KEY="sk-your-deepseek-api-key"' >> ~/.bashrc
source ~/.bashrc
```

#### IntelliJ IDEA / JetBrains IDE
1. æ‰“å¼€ **Run/Debug Configurations**
2. åœ¨ **Environment variables** ä¸­æ·»åŠ ï¼š
   ```
   AI_API_KEY=sk-your-deepseek-api-key
   ```

### æ­¥éª¤3ï¼šä½¿ç”¨LLMå®¢æˆ·ç«¯

```java
import top.yumbo.ai.rag.example.llm.MockLLMClient;

// è‡ªåŠ¨ä»ç¯å¢ƒå˜é‡è¯»å–API Key
MockLLMClient llmClient = new MockLLMClient();

// æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
if (llmClient.isApiAvailable()) {
    System.out.println("âœ… DeepSeek API å·²è¿æ¥");
} else {
    System.out.println("âš ï¸ æœªè®¾ç½®API Keyï¼Œä½¿ç”¨Mockæ¨¡å¼");
}

// ç”Ÿæˆå›ç­”
String prompt = "è¯·æ€»ç»“ä»¥ä¸‹å†…å®¹ï¼š...";
String response = llmClient.generate(prompt);
System.out.println(response);
```

---

## ğŸ”§ é…ç½®é€‰é¡¹

### é»˜è®¤é…ç½®

```java
public class MockLLMClient implements LLMClient {
    private static final String DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions";
    private static final String DEFAULT_MODEL = "deepseek-chat";
    private static final int DEFAULT_MAX_TOKENS = 2000;
    private static final double DEFAULT_TEMPERATURE = 0.7;
    
    // ä»ç¯å¢ƒå˜é‡ AI_API_KEY è¯»å–
}
```

### è‡ªå®šä¹‰é…ç½®

```java
// è‡ªå®šä¹‰æ¨¡å‹å’ŒAPI Key
MockLLMClient llmClient = new MockLLMClient(
    "sk-your-api-key",    // ç›´æ¥ä¼ å…¥API Key
    "deepseek-coder"      // ä½¿ç”¨ä»£ç æ¨¡å‹
);
```

### æ”¯æŒçš„æ¨¡å‹

DeepSeekæä¾›å¤šä¸ªæ¨¡å‹ï¼š
- `deepseek-chat` - é€šç”¨å¯¹è¯æ¨¡å‹ï¼ˆæ¨èï¼‰â­
- `deepseek-coder` - ä»£ç ç”Ÿæˆæ¨¡å‹

---

## ğŸ“Š APIè°ƒç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šExcelçŸ¥è¯†åº“æŸ¥è¯¢

```java
// åœ¨ExcelKnowledgeQueryExampleä¸­ä½¿ç”¨
LLMClient llmClient = new MockLLMClient();

String question = "2024å¹´ç¬¬ä¸€å­£åº¦çš„é”€å”®é¢æ˜¯å¤šå°‘ï¼Ÿ";
String context = """
    [Excelæ–‡ä»¶: sales_2024Q1.xlsx]
    æœˆä»½  é”€å”®é¢
    1æœˆ   150ä¸‡
    2æœˆ   180ä¸‡
    3æœˆ   170ä¸‡
    """;

String prompt = buildPrompt(question, context);
String answer = llmClient.generate(prompt);

// è¾“å‡ºï¼š
// æ ¹æ®Excelæ–‡ä»¶æ•°æ®ï¼Œ2024å¹´ç¬¬ä¸€å­£åº¦çš„é”€å”®é¢ä¸ºï¼š
// - 1æœˆï¼š150ä¸‡å…ƒ
// - 2æœˆï¼š180ä¸‡å…ƒ
// - 3æœˆï¼š170ä¸‡å…ƒ
// æ€»è®¡ï¼š500ä¸‡å…ƒ
```

### ç¤ºä¾‹2ï¼šå®Œæ•´çš„RAGé—®ç­”æµç¨‹

```java
public class RAGQueryDemo {
    public static void main(String[] args) {
        // 1. åˆå§‹åŒ–çŸ¥è¯†åº“
        LocalFileRAG rag = LocalFileRAG.builder()
            .storagePath("./data/knowledge-base")
            .build();
        
        // 2. åˆå§‹åŒ–LLMå®¢æˆ·ç«¯
        LLMClient llmClient = new MockLLMClient();
        
        // 3. æœç´¢ç›¸å…³æ–‡æ¡£
        SearchResult result = rag.search(Query.builder()
            .queryText("é”€å”®æ•°æ®")
            .limit(5)
            .build());
        
        // 4. æ„å»ºä¸Šä¸‹æ–‡
        String context = result.getDocuments().stream()
            .map(doc -> doc.getContent())
            .collect(Collectors.joining("\n\n"));
        
        // 5. ç”Ÿæˆå›ç­”
        String prompt = String.format("""
            è¯·åŸºäºä»¥ä¸‹æ–‡æ¡£å†…å®¹å›ç­”é—®é¢˜ï¼š
            
            æ–‡æ¡£å†…å®¹ï¼š
            %s
            
            é—®é¢˜ï¼š%s
            """, context, "æ€»ç»“é”€å”®æƒ…å†µ");
        
        String answer = llmClient.generate(prompt);
        System.out.println(answer);
    }
}
```

---

## ğŸ“ˆ æ—¥å¿—è¾“å‡º

### å¯åŠ¨æ—¥å¿—

```
2025-11-22 00:40:00 INFO  DeepSeek LLM Client initialized with model: deepseek-chat
2025-11-22 00:40:00 INFO  âœ… DeepSeek API Key loaded from environment variable
```

### è°ƒç”¨æ—¥å¿—

```
2025-11-22 00:40:05 DEBUG Calling DeepSeek API with prompt length: 1234
2025-11-22 00:40:07 DEBUG DeepSeek API response received in 1823ms, status: 200
2025-11-22 00:40:07 INFO  Token usage - Prompt: 256, Completion: 128, Total: 384
```

### Mockæ¨¡å¼æ—¥å¿—

```
2025-11-22 00:40:00 WARN  âš ï¸ AI_API_KEY environment variable not set. Using mock mode.
2025-11-22 00:40:05 DEBUG Using mock response (no API key)
```

---

## ğŸ’° è´¹ç”¨è¯´æ˜

### DeepSeekå®šä»·ï¼ˆæˆªè‡³2024å¹´11æœˆï¼‰

| æ¨¡å‹ | è¾“å…¥ä»·æ ¼ | è¾“å‡ºä»·æ ¼ | ä¸Šä¸‹æ–‡é•¿åº¦ |
|-----|---------|---------|----------|
| deepseek-chat | Â¥0.001/1K tokens | Â¥0.002/1K tokens | 32K |
| deepseek-coder | Â¥0.001/1K tokens | Â¥0.002/1K tokens | 16K |

### æˆæœ¬ä¼°ç®—

**ç¤ºä¾‹åœºæ™¯ï¼š1000ä¸ªExcelæ–‡ä»¶æŸ¥è¯¢**
- å¹³å‡æ¯æ¬¡æŸ¥è¯¢ï¼š500 tokens (è¾“å…¥) + 200 tokens (è¾“å‡º)
- æ€»tokensï¼š500K (è¾“å…¥) + 200K (è¾“å‡º)
- æˆæœ¬ï¼š(500 Ã— Â¥0.001) + (200 Ã— Â¥0.002) = Â¥0.9

**éå¸¸ä¾¿å®œï¼** ğŸ’°

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ˜¾ç¤º"Using mock mode"

**åŸå› **ï¼šç¯å¢ƒå˜é‡æœªè®¾ç½®æˆ–è®¾ç½®é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
echo $AI_API_KEY  # Linux/Mac
echo %AI_API_KEY%  # Windows CMD
$env:AI_API_KEY    # Windows PowerShell

# é‡æ–°è®¾ç½®
export AI_API_KEY="sk-your-api-key"
```

### é—®é¢˜2ï¼šAPIè°ƒç”¨å¤±è´¥ï¼ˆStatus 401ï¼‰

**åŸå› **ï¼šAPI Keyæ— æ•ˆæˆ–è¿‡æœŸ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥API Keyæ˜¯å¦æ­£ç¡®å¤åˆ¶
2. åœ¨DeepSeekæ§åˆ¶å°éªŒè¯Keyæ˜¯å¦æœ‰æ•ˆ
3. ç¡®è®¤Keyæœªè¾¾åˆ°ä½¿ç”¨é™é¢

### é—®é¢˜3ï¼šAPIè°ƒç”¨è¶…æ—¶

**åŸå› **ï¼šç½‘ç»œé—®é¢˜æˆ–APIæœåŠ¡ç¹å¿™

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç­‰å¾…åé‡è¯•
- ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§åˆ°Mockæ¨¡å¼

### é—®é¢˜4ï¼šåœ¨IDEä¸­è¿è¡Œæç¤ºæœªæ‰¾åˆ°API Key

**åŸå› **ï¼šIDEæœªè¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨Run Configurationä¸­æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡
2. æˆ–é‡å¯IDEä½¿å…¶è¯»å–æ–°çš„ç¯å¢ƒå˜é‡

---

## ğŸ”’ å®‰å…¨å»ºè®®

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨ç¯å¢ƒå˜é‡**
   ```bash
   # âœ… æ­£ç¡®
   export AI_API_KEY="sk-xxxx"
   ```

2. **ä¸è¦ç¡¬ç¼–ç API Key**
   ```java
   // âŒ é”™è¯¯ - ä¸è¦è¿™æ ·åš
   String apiKey = "sk-your-actual-key";
   
   // âœ… æ­£ç¡®
   String apiKey = System.getenv("AI_API_KEY");
   ```

3. **ä¸è¦æäº¤API Keyåˆ°Git**
   ```gitignore
   # æ·»åŠ åˆ° .gitignore
   .env
   *.key
   config/secrets.properties
   ```

4. **å®šæœŸè½®æ¢API Key**
   - æ¯3-6ä¸ªæœˆæ›´æ¢ä¸€æ¬¡
   - å‘ç°æ³„éœ²ç«‹å³åºŸå¼ƒ

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ§åˆ¶Tokenä½¿ç”¨

```java
// åœ¨æ„å»ºPromptæ—¶é™åˆ¶é•¿åº¦
String context = documents.stream()
    .map(doc -> {
        String content = doc.getContent();
        // é™åˆ¶æ¯ä¸ªæ–‡æ¡£æœ€å¤š2000å­—ç¬¦
        if (content.length() > 2000) {
            content = content.substring(0, 2000) + "...";
        }
        return content;
    })
    .collect(Collectors.joining("\n\n"));
```

### 2. æ‰¹é‡å¤„ç†

```java
// ä¸€æ¬¡æ€§å¤„ç†å¤šä¸ªé—®é¢˜
String prompt = """
    è¯·å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š
    1. ç¬¬ä¸€å­£åº¦é”€å”®é¢ï¼Ÿ
    2. åŒæ¯”å¢é•¿ç‡ï¼Ÿ
    3. ä¸»è¦å¢é•¿å› ç´ ï¼Ÿ
    """;
// ç›¸æ¯”3æ¬¡å•ç‹¬è°ƒç”¨ï¼ŒèŠ‚çœçº¦40%çš„token
```

### 3. ä½¿ç”¨ç¼“å­˜

```java
// ç¼“å­˜å¸¸è§é—®é¢˜çš„ç­”æ¡ˆ
Map<String, String> answerCache = new HashMap<>();

String answer = answerCache.computeIfAbsent(question, q -> {
    return llmClient.generate(buildPrompt(q, context));
});
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. Promptå·¥ç¨‹

```java
// âœ… å¥½çš„Prompt - æ¸…æ™°ã€ç»“æ„åŒ–
String prompt = """
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®åˆ†æå¸ˆã€‚è¯·åŸºäºä»¥ä¸‹Excelæ•°æ®å›ç­”é—®é¢˜ã€‚
    
    # æ•°æ®æ¥æº
    æ–‡ä»¶ï¼šsales_2024Q1.xlsx
    
    # æ•°æ®å†…å®¹
    æœˆä»½  é”€å”®é¢  åŒæ¯”å¢é•¿
    1æœˆ   150ä¸‡  +15%
    2æœˆ   180ä¸‡  +20%
    3æœˆ   170ä¸‡  +18%
    
    # é—®é¢˜
    è¯·æ€»ç»“ç¬¬ä¸€å­£åº¦çš„é”€å”®è¶‹åŠ¿ã€‚
    
    # è¦æ±‚
    1. æ•°æ®å‡†ç¡®
    2. åˆ†æç®€æ´
    3. æä¾›ç»“è®º
    """;

// âŒ ä¸å¥½çš„Prompt - æ¨¡ç³Šã€æ— ç»“æ„
String badPrompt = "è¿™äº›æ•°æ®æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ150ä¸‡ 180ä¸‡ 170ä¸‡";
```

### 2. é”™è¯¯å¤„ç†

```java
try {
    String answer = llmClient.generate(prompt);
    return answer;
} catch (Exception e) {
    log.error("LLMè°ƒç”¨å¤±è´¥", e);
    // é™çº§ç­–ç•¥
    return "æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚";
}
```

### 3. ç›‘æ§Tokenä½¿ç”¨

```java
// è®°å½•æ¯æ¬¡è°ƒç”¨çš„tokenä½¿ç”¨
public class TokenTracker {
    private int totalTokens = 0;
    
    public void track(int tokens) {
        totalTokens += tokens;
        log.info("Cumulative tokens: {}", totalTokens);
        
        if (totalTokens > 100000) {
            log.warn("âš ï¸ Token usage exceeds 100K");
        }
    }
}
```

---

## ğŸ”„ ç‰ˆæœ¬å†å²

### v1.0 (2025-11-22)
- âœ… å®ç°DeepSeek APIé›†æˆ
- âœ… æ”¯æŒç¯å¢ƒå˜é‡é…ç½®
- âœ… è‡ªåŠ¨é™çº§åˆ°Mockæ¨¡å¼
- âœ… Tokenä½¿ç”¨ç»Ÿè®¡
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•

---

## ğŸ“š ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [DeepSeek APIæ–‡æ¡£](https://platform.deepseek.com/docs)
- [OpenAIå…¼å®¹æ€§è¯´æ˜](https://platform.deepseek.com/docs/openai-compatibility)

### ä»£ç ç¤ºä¾‹
- [MockLLMClientæºç ](../src/main/java/top/yumbo/ai/rag/example/llm/MockLLMClient.java)
- [ExcelKnowledgeQueryExample](../src/main/java/top/yumbo/ai/rag/example/ExcelKnowledgeQueryExample.java)

---

## âœ… éªŒè¯æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ï¼š

- [ ] å·²è·å–DeepSeek API Key
- [ ] ç¯å¢ƒå˜é‡ AI_API_KEY å·²è®¾ç½®
- [ ] æµ‹è¯•APIè¿æ¥æˆåŠŸ
- [ ] æ—¥å¿—æ˜¾ç¤º"DeepSeek API Key loaded"
- [ ] Tokenä½¿ç”¨è®°å½•æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶æœ‰æ•ˆ

---

**å®æ–½çŠ¶æ€**: âœ… å®Œæˆ  
**æ¨èä½¿ç”¨**: â­â­â­â­â­  
**æˆæœ¬æ•ˆç›Š**: ğŸ’° æé«˜ï¼ˆçº¦Â¥0.001/æ¬¡æŸ¥è¯¢ï¼‰

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸš€

