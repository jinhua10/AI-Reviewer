# ExcelçŸ¥è¯†åº“ç¤ºä¾‹ - å†…å­˜ä¸æ€§èƒ½é—®é¢˜åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-11-22  
**åˆ†æç›®æ ‡**: `ExcelKnowledgeQueryExample` åŠç›¸å…³çš„çŸ¥è¯†åº“æ„å»ºæµç¨‹  
**ä¸¥é‡ç¨‹åº¦è¯„ä¼°**: âš ï¸ **ä¸­ç­‰åˆ°é«˜é£é™©** - å­˜åœ¨å¤šä¸ªéœ€è¦ä¼˜åŒ–çš„æ€§èƒ½å’Œå†…å­˜é—®é¢˜

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

ç»è¿‡å¯¹ExcelçŸ¥è¯†åº“ç¤ºä¾‹ä»£ç çš„å…¨é¢åˆ†æï¼Œå‘ç°**å­˜åœ¨å¤šä¸ªæ½œåœ¨çš„å†…å­˜å’Œæ€§èƒ½é—®é¢˜**ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§è§„æ¨¡Excelæ–‡ä»¶æ—¶ã€‚ä¸»è¦é—®é¢˜é›†ä¸­åœ¨ï¼š

1. **å…¨é‡å†…å­˜åŠ è½½** - Excelè§£ææ—¶ä¸€æ¬¡æ€§åŠ è½½å…¨éƒ¨å†…å®¹
2. **æ‰¹å¤„ç†ä¸è¶³** - ç¼ºä¹æœ‰æ•ˆçš„å†…å­˜æ§åˆ¶æœºåˆ¶
3. **å­—ç¬¦ä¸²æˆªæ–­ç­–ç•¥ä¸å®Œå–„** - ä»…åœ¨æŸ¥è¯¢ç«¯å¤„ç†ï¼Œæ„å»ºç«¯æœªé™åˆ¶
4. **ç¼ºå°‘æµå¼å¤„ç†** - å¤§æ–‡ä»¶å¤„ç†å¯èƒ½å¯¼è‡´OOM

---

## ğŸ” è¯¦ç»†é—®é¢˜åˆ†æ

### 1. âš ï¸ **é«˜å±é—®é¢˜ï¼šExcelå…¨é‡å†…å­˜è§£æ**

#### é—®é¢˜ä½ç½®
```java
// ExcelKnowledgeBuilder.java:217
private String extractExcelContent(File file) throws IOException {
    return new top.yumbo.ai.rag.impl.parser.TikaDocumentParser().parse(file);
}
```

#### é—®é¢˜æè¿°
- **Apache Tikaé»˜è®¤å°†æ•´ä¸ªExcelæ–‡ä»¶å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­**
- å¯¹äºåŒ…å«æ•°ä¸‡è¡Œæ•°æ®çš„å¤§å‹Excelæ–‡ä»¶ï¼Œè¿™ä¼šå¯¼è‡´ï¼š
  - å•ä¸ªæ–‡ä»¶å¯èƒ½å ç”¨æ•°åMBç”šè‡³æ•°ç™¾MBå†…å­˜
  - å¤šä¸ªå¤§æ–‡ä»¶å¹¶å‘å¤„ç†æ—¶å®¹æ˜“è§¦å‘OOMï¼ˆOut Of Memoryï¼‰
  
#### å½±å“è¯„ä¼°
| æ–‡ä»¶å¤§å° | é¢„ä¼°å†…å­˜å ç”¨ | é£é™©ç­‰çº§ |
|---------|-------------|---------|
| < 5MB   | < 50MB      | ğŸŸ¢ ä½ |
| 5-20MB  | 50-200MB    | ğŸŸ¡ ä¸­ |
| 20-50MB | 200-500MB   | ğŸŸ  é«˜ |
| > 50MB  | > 500MB     | ğŸ”´ æé«˜ |

#### å®é™…åœºæ™¯ç¤ºä¾‹
```text
å‡è®¾åœºæ™¯ï¼š
- Excelæ–‡ä»¶ï¼š100ä¸ªæ–‡ä»¶ï¼Œå¹³å‡æ¯ä¸ª10MB
- Tikaè§£æåå†…å®¹ï¼šå¹³å‡æ¯ä¸ªæ–‡ä»¶30MBæ–‡æœ¬
- å¦‚æœæŒ‰å½“å‰ä»£ç æ¯10ä¸ªæäº¤ä¸€æ¬¡ï¼Œå³°å€¼å†…å­˜å ç”¨å¯èƒ½è¾¾åˆ°ï¼š
  30MB Ã— 10 = 300MBï¼ˆä»…æ–‡æ¡£å†…å®¹ï¼‰
  + JVMå¯¹è±¡å¼€é”€ + Luceneç´¢å¼•ç¼“å†² = å¯èƒ½è¶…è¿‡500MB
```

---

### 2. âš ï¸ **ä¸­å±é—®é¢˜ï¼šæ‰¹å¤„ç†æäº¤é—´éš”ä¸åˆç†**

#### é—®é¢˜ä½ç½®
```java
// ExcelKnowledgeBuilder.java:97-101
// æ¯å¤„ç†10ä¸ªæ–‡ä»¶æäº¤ä¸€æ¬¡
if ((result.successCount + result.failedCount) % 10 == 0) {
    rag.commit();
    log.info("è¿›åº¦: {}/{}", result.successCount + result.failedCount, result.totalFiles);
}
```

#### é—®é¢˜æè¿°
1. **å›ºå®šæ•°é‡æäº¤ç­–ç•¥**ï¼š
   - 10ä¸ªå°æ–‡ä»¶ï¼ˆ1MBï¼‰vs 10ä¸ªå¤§æ–‡ä»¶ï¼ˆ50MBï¼‰å†…å­˜å ç”¨å·®è·å·¨å¤§
   - åº”è¯¥åŸºäº**å†…å­˜å ç”¨**æˆ–**æ–‡æ¡£å¤§å°æ€»å’Œ**æ¥å†³å®šæäº¤æ—¶æœº

2. **å†…å­˜æœªåŠæ—¶é‡Šæ”¾**ï¼š
   - æäº¤åæœªæ˜¾å¼æ¸…ç†æ–‡æ¡£å¯¹è±¡å¼•ç”¨
   - ä¾èµ–GCè¢«åŠ¨å›æ”¶ï¼Œå¯èƒ½å»¶è¿Ÿé‡Šæ”¾

#### å»ºè®®ä¼˜åŒ–ç­–ç•¥
```java
// æ”¹è¿›æ–¹æ¡ˆï¼šåŸºäºå†…å­˜é˜ˆå€¼çš„åŠ¨æ€æäº¤
private static final long MEMORY_THRESHOLD = 100 * 1024 * 1024; // 100MB
private long currentBatchSize = 0;

for (File file : excelFiles) {
    long fileSize = file.length();
    
    if (processExcelFile(file)) {
        currentBatchSize += fileSize * 3; // ä¼°ç®—è§£æåå¤§å°ï¼ˆçº¦3å€ï¼‰
        result.successCount++;
        
        // åŸºäºå†…å­˜é˜ˆå€¼æäº¤
        if (currentBatchSize >= MEMORY_THRESHOLD) {
            rag.commit();
            System.gc(); // å»ºè®®GC
            currentBatchSize = 0;
        }
    }
}
```

---

### 3. âš ï¸ **ä¸­å±é—®é¢˜ï¼šæŸ¥è¯¢ç«¯çš„å†…å®¹æˆªæ–­ä¸å½»åº•**

#### é—®é¢˜ä½ç½®
```java
// ExcelKnowledgeQueryExample.java:98-102
// é™åˆ¶æ¯ä¸ªæ–‡æ¡£çš„é•¿åº¦ï¼Œé¿å…è¶…è¿‡LLMçš„tokené™åˆ¶
if (content.length() > 2000) {
    content = content.substring(0, 2000) + "...";
}
```

#### é—®é¢˜æè¿°
1. **ä»…åœ¨æŸ¥è¯¢æ—¶æˆªæ–­**ï¼š
   - å­˜å‚¨æ—¶æœªé™åˆ¶ï¼Œå¤§æ–‡æ¡£ä»ç„¶å®Œæ•´å­˜å‚¨åœ¨ç£ç›˜å’Œç´¢å¼•ä¸­
   - Luceneç´¢å¼•ä¼šåŒ…å«æ‰€æœ‰å†…å®¹ï¼Œå ç”¨å¤§é‡ç£ç›˜ç©ºé—´

2. **æˆªæ–­ç­–ç•¥è¿‡äºç®€å•**ï¼š
   - 2000å­—ç¬¦çš„ç¡¬é™åˆ¶å¯èƒ½æˆªæ–­é‡è¦ä¿¡æ¯
   - åº”è¯¥é‡‡ç”¨æ™ºèƒ½åˆ†å—ç­–ç•¥ï¼ˆchunkï¼‰

3. **æ£€ç´¢é˜¶æ®µçš„å†…å­˜å³°å€¼**ï¼š
   ```java
   // å¦‚æœæ£€ç´¢åˆ°5ä¸ªå¤§æ–‡æ¡£ï¼ˆæ¯ä¸ª1MBï¼‰
   SearchResult searchResult = rag.search(Query.builder()
       .queryText(question)
       .limit(5)  // 5ä¸ªæ–‡æ¡£ Ã— 1MB = 5MB
       .build());
   ```

#### ä¼˜åŒ–å»ºè®®
```java
// æ–¹æ¡ˆ1ï¼šåœ¨æ„å»ºæ—¶åˆ†å—
private List<Document> chunkLargeDocument(Document doc, int maxChunkSize) {
    List<Document> chunks = new ArrayList<>();
    String content = doc.getContent();
    
    for (int i = 0; i < content.length(); i += maxChunkSize) {
        int end = Math.min(i + maxChunkSize, content.length());
        Document chunk = doc.clone();
        chunk.setContent(content.substring(i, end));
        chunk.setId(doc.getId() + "_chunk_" + (i / maxChunkSize));
        chunks.add(chunk);
    }
    return chunks;
}

// æ–¹æ¡ˆ2ï¼šå»¶è¿ŸåŠ è½½æ–‡æ¡£å†…å®¹
// åªæ£€ç´¢æ–‡æ¡£IDå’Œå…ƒæ•°æ®ï¼Œéœ€è¦æ—¶å†åŠ è½½å®Œæ•´å†…å®¹
```

---

### 4. âš ï¸ **ä½å±ä½†éœ€å…³æ³¨ï¼šTikaDocumentParserçš„å†…å­˜è¡Œä¸º**

#### é—®é¢˜ä½ç½®
```java
// TikaDocumentParser.java:71-73
public String parse(File file) {
    String content = tika.parseToString(file);
    return content;
}
```

#### é—®é¢˜æè¿°
- `tika.parseToString()` è¿”å›å®Œæ•´çš„å­—ç¬¦ä¸²
- å¯¹äºå¤§å‹Excelï¼ˆå¦‚åŒ…å«å›¾ç‰‡ã€å¤æ‚å…¬å¼ï¼‰ï¼Œè§£æåçš„æ–‡æœ¬å¯èƒ½è¿œå¤§äºåŸæ–‡ä»¶
- æ²¡æœ‰è®¾ç½®Tikaçš„è§£æé™åˆ¶ï¼ˆå¦‚æœ€å¤§å­—ç¬¦æ•°ï¼‰

#### Tikaé…ç½®ä¼˜åŒ–
```java
// æ”¹è¿›æ–¹æ¡ˆï¼šè®¾ç½®è§£æé™åˆ¶
import org.apache.tika.config.TikaConfig;
import org.apache.tika.parser.ParseContext;
import org.apache.tika.sax.BodyContentHandler;

public class TikaDocumentParser implements DocumentParser {
    private static final int MAX_STRING_LENGTH = 10 * 1024 * 1024; // 10MB
    
    @Override
    public String parse(File file) {
        try {
            // é™åˆ¶è§£æå†…å®¹çš„æœ€å¤§é•¿åº¦
            BodyContentHandler handler = new BodyContentHandler(MAX_STRING_LENGTH);
            Metadata metadata = new Metadata();
            
            try (InputStream stream = Files.newInputStream(file.toPath())) {
                tika.getParser().parse(stream, handler, metadata, new ParseContext());
            }
            
            return handler.toString();
            
        } catch (TikaException e) {
            if (e.getMessage().contains("exceeds max length")) {
                log.warn("Document too large, truncated: {}", file.getName());
                // è¿”å›æˆªæ–­çš„å†…å®¹
            }
            throw e;
        }
    }
}
```

---

### 5. âš ï¸ **æ¶æ„é—®é¢˜ï¼šç¼ºå°‘æµå¼å¤„ç†èƒ½åŠ›**

#### å½“å‰æ¶æ„é™åˆ¶
```java
// FileSystemStorageEngine.java:91-94
if (compressionEnabled) {
    writeCompressed(filePath, document.getContent());
} else {
    Files.writeString(filePath, document.getContent());
}
```

#### é—®é¢˜æè¿°
- æ–‡æ¡£å†…å®¹å¿…é¡»å®Œæ•´åŠ è½½ä¸ºString
- æ— æ³•æ”¯æŒæµå¼è¯»å†™ï¼ˆStream APIï¼‰
- å¤§æ–‡æ¡£å¤„ç†æ—¶å†…å­˜å‹åŠ›å¤§

#### å»ºè®®æ”¹è¿›
```java
// æ·»åŠ æµå¼APIæ”¯æŒ
public interface StorageEngine {
    // ç°æœ‰æ–¹æ³•
    String store(Document document);
    
    // æ–°å¢ï¼šæµå¼å­˜å‚¨
    String storeStream(String id, InputStream contentStream, Map<String, Object> metadata);
    
    // æ–°å¢ï¼šæµå¼è¯»å–
    InputStream retrieveStream(String id);
}
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯è®¾è®¡

#### åœºæ™¯1ï¼šå°æ–‡ä»¶æ‰¹é‡å¤„ç†
```yaml
æµ‹è¯•æ¡ä»¶:
  - æ–‡ä»¶æ•°é‡: 1000ä¸ª
  - å•æ–‡ä»¶å¤§å°: 100KB - 1MB
  - æ€»æ•°æ®é‡: ~500MB
  
é¢„æœŸç»“æœ:
  - å³°å€¼å†…å­˜: < 500MB
  - å¤„ç†æ—¶é—´: < 5åˆ†é’Ÿ
  - GCæš‚åœ: < 100ms
```

#### åœºæ™¯2ï¼šå¤§æ–‡ä»¶å¤„ç†
```yaml
æµ‹è¯•æ¡ä»¶:
  - æ–‡ä»¶æ•°é‡: 10ä¸ª
  - å•æ–‡ä»¶å¤§å°: 50-100MB
  - æ€»æ•°æ®é‡: ~500MB
  
é¢„æœŸç»“æœ:
  - å³°å€¼å†…å­˜: < 1GB
  - å¤„ç†æ—¶é—´: < 10åˆ†é’Ÿ
  - æ— OOMé”™è¯¯
```

#### åœºæ™¯3ï¼šæ··åˆåœºæ™¯ï¼ˆçœŸå®ä¸–ç•Œï¼‰
```yaml
æµ‹è¯•æ¡ä»¶:
  - å°æ–‡ä»¶: 800ä¸ª (< 1MB)
  - ä¸­æ–‡ä»¶: 150ä¸ª (1-10MB)
  - å¤§æ–‡ä»¶: 50ä¸ª (10-50MB)
  - æ€»æ•°æ®é‡: ~2GB
  
é¢„æœŸç»“æœ:
  - å³°å€¼å†…å­˜: < 2GB
  - å¤„ç†æ—¶é—´: < 30åˆ†é’Ÿ
  - ç¨³å®šè¿è¡Œæ— å´©æºƒ
```

### ç›‘æ§æŒ‡æ ‡
```java
// æ·»åŠ æ€§èƒ½ç›‘æ§
public class PerformanceMonitor {
    private final Runtime runtime = Runtime.getRuntime();
    
    public void logMemoryUsage(String phase) {
        long totalMemory = runtime.totalMemory();
        long freeMemory = runtime.freeMemory();
        long usedMemory = totalMemory - freeMemory;
        long maxMemory = runtime.maxMemory();
        
        log.info("[{}] Memory - Used: {}MB, Free: {}MB, Max: {}MB",
            phase,
            usedMemory / 1024 / 1024,
            freeMemory / 1024 / 1024,
            maxMemory / 1024 / 1024);
    }
}
```

---

## ğŸ› ï¸ ä¼˜åŒ–æ–¹æ¡ˆæ€»ç»“

### çŸ­æœŸä¼˜åŒ–ï¼ˆç«‹å³å¯å®æ–½ï¼‰

#### 1. æ·»åŠ æ–‡æ¡£å¤§å°é™åˆ¶
```java
// ExcelKnowledgeBuilder.java
private static final long MAX_CONTENT_SIZE = 5 * 1024 * 1024; // 5MB

private boolean processExcelFile(File file) {
    // æ£€æŸ¥æ–‡ä»¶å¤§å°
    if (file.length() > 100 * 1024 * 1024) { // 100MB
        log.warn("File too large, skipping: {} ({}MB)", 
            file.getName(), file.length() / 1024 / 1024);
        return false;
    }
    
    String content = extractExcelContent(file);
    
    // é™åˆ¶å†…å®¹å¤§å°
    if (content.length() > MAX_CONTENT_SIZE) {
        log.warn("Content too large, truncating: {}", file.getName());
        content = content.substring(0, (int) MAX_CONTENT_SIZE);
    }
    
    // ...ç»§ç»­å¤„ç†
}
```

#### 2. æ”¹è¿›æ‰¹å¤„ç†ç­–ç•¥
```java
// åŸºäºå†…å­˜çš„åŠ¨æ€æäº¤
private static final long BATCH_MEMORY_THRESHOLD = 100 * 1024 * 1024; // 100MB
private long currentBatchMemory = 0;

for (File file : excelFiles) {
    if (processExcelFile(file)) {
        currentBatchMemory += file.length() * 3; // ä¼°ç®—å€æ•°
        result.successCount++;
        
        if (currentBatchMemory >= BATCH_MEMORY_THRESHOLD) {
            rag.commit();
            currentBatchMemory = 0;
            System.gc(); // å»ºè®®GC
            
            log.info("Batch committed, memory released");
        }
    }
}
```

#### 3. æ·»åŠ å†…å­˜ç›‘æ§
```java
// åœ¨å…³é”®ä½ç½®æ·»åŠ ç›‘æ§
private void monitorMemory(String phase) {
    Runtime runtime = Runtime.getRuntime();
    long usedMB = (runtime.totalMemory() - runtime.freeMemory()) / 1024 / 1024;
    long maxMB = runtime.maxMemory() / 1024 / 1024;
    
    log.info("[{}] Memory: {} / {} MB ({}%)", 
        phase, usedMB, maxMB, usedMB * 100 / maxMB);
    
    if (usedMB > maxMB * 0.8) {
        log.warn("Memory usage high, suggesting GC");
        System.gc();
    }
}
```

### ä¸­æœŸä¼˜åŒ–ï¼ˆéœ€è¦æ¶æ„è°ƒæ•´ï¼‰

#### 1. å®ç°æ–‡æ¡£åˆ†å—ï¼ˆChunkingï¼‰
```java
/**
 * æ™ºèƒ½æ–‡æ¡£åˆ†å—å™¨
 * å°†å¤§æ–‡æ¡£æ‹†åˆ†ä¸ºå¤šä¸ªå°å—ï¼Œæé«˜æ£€ç´¢ç²¾åº¦å¹¶é™ä½å†…å­˜å ç”¨
 */
public class DocumentChunker {
    private static final int DEFAULT_CHUNK_SIZE = 1000; // å­—ç¬¦
    private static final int CHUNK_OVERLAP = 200; // é‡å åŒºåŸŸ
    
    public List<Document> chunk(Document document) {
        List<Document> chunks = new ArrayList<>();
        String content = document.getContent();
        
        if (content.length() <= DEFAULT_CHUNK_SIZE) {
            return List.of(document);
        }
        
        int start = 0;
        int chunkIndex = 0;
        
        while (start < content.length()) {
            int end = Math.min(start + DEFAULT_CHUNK_SIZE, content.length());
            
            // å°è¯•åœ¨å¥å­è¾¹ç•Œå¤„åˆ†å‰²
            if (end < content.length()) {
                int lastPeriod = content.lastIndexOf('.', end);
                if (lastPeriod > start) {
                    end = lastPeriod + 1;
                }
            }
            
            String chunkContent = content.substring(start, end);
            
            Document chunk = Document.builder()
                .id(document.getId() + "_chunk_" + chunkIndex)
                .title(document.getTitle() + " (Part " + (chunkIndex + 1) + ")")
                .content(chunkContent)
                .metadata(new HashMap<>(document.getMetadata()))
                .build();
            
            chunk.getMetadata().put("chunkIndex", chunkIndex);
            chunk.getMetadata().put("chunkStart", start);
            chunk.getMetadata().put("chunkEnd", end);
            chunk.getMetadata().put("parentDocId", document.getId());
            
            chunks.add(chunk);
            
            start = end - CHUNK_OVERLAP; // é‡å é¿å…ä¿¡æ¯ä¸¢å¤±
            chunkIndex++;
        }
        
        log.info("Document chunked: {} -> {} chunks", document.getId(), chunks.size());
        return chunks;
    }
}
```

#### 2. å®ç°å»¶è¿ŸåŠ è½½
```java
/**
 * å»¶è¿ŸåŠ è½½çš„æ–‡æ¡£å¼•ç”¨
 * åªåœ¨éœ€è¦æ—¶æ‰åŠ è½½å®Œæ•´å†…å®¹
 */
public class LazyDocument {
    private final String id;
    private final Map<String, Object> metadata;
    private final StorageEngine storage;
    private String content; // å»¶è¿ŸåŠ è½½
    
    public String getContent() {
        if (content == null) {
            Document full = storage.retrieve(id);
            content = full.getContent();
        }
        return content;
    }
}

// åœ¨æœç´¢ç»“æœä¸­ä½¿ç”¨
public SearchResult search(Query query) {
    // åªè¿”å›æ–‡æ¡£å¼•ç”¨ï¼Œä¸åŠ è½½å†…å®¹
    List<LazyDocument> lazyDocs = indexEngine.searchLazy(query);
    return SearchResult.builder()
        .documents(lazyDocs)
        .build();
}
```

#### 3. æ·»åŠ æµå¼å¤„ç†æ”¯æŒ
```java
/**
 * æµå¼Excelå¤„ç†å™¨
 * é€è¡Œè¯»å–Excelï¼Œé¿å…å…¨é‡åŠ è½½
 */
public class StreamingExcelParser {
    public Stream<String> parseAsStream(File file) throws IOException {
        // ä½¿ç”¨Apache POIçš„æµå¼API
        try (OPCPackage pkg = OPCPackage.open(file)) {
            XSSFReader reader = new XSSFReader(pkg);
            
            // è¿”å›æµï¼Œé€è¡Œå¤„ç†
            return StreamSupport.stream(
                new ExcelRowSpliterator(reader), false);
        }
    }
}
```

### é•¿æœŸä¼˜åŒ–ï¼ˆé‡æ„å»ºè®®ï¼‰

#### 1. å¼•å…¥å†…å­˜æ± ç®¡ç†
```java
/**
 * æ–‡æ¡£å†…å­˜æ± 
 * é™åˆ¶åŒæ—¶å¤„ç†çš„æ–‡æ¡£æ•°é‡
 */
public class DocumentMemoryPool {
    private final Semaphore permits;
    private final long maxMemoryPerDoc;
    
    public DocumentMemoryPool(int maxConcurrent, long maxMemoryPerDoc) {
        this.permits = new Semaphore(maxConcurrent);
        this.maxMemoryPerDoc = maxMemoryPerDoc;
    }
    
    public void processDocument(File file, Consumer<Document> processor) {
        try {
            permits.acquire();
            
            Document doc = parseDocument(file);
            processor.accept(doc);
            
        } finally {
            permits.release();
        }
    }
}
```

#### 2. å®ç°å¢é‡ç´¢å¼•æ›´æ–°
```java
/**
 * æ™ºèƒ½å¢é‡æ›´æ–°
 * åªæ›´æ–°å˜åŒ–çš„æ–‡æ¡£
 */
public class IncrementalIndexer {
    private final Map<String, String> fileHashCache; // æ–‡ä»¶->å“ˆå¸Œæ˜ å°„
    
    public void incrementalUpdate(List<File> files) {
        for (File file : files) {
            String currentHash = computeFileHash(file);
            String cachedHash = fileHashCache.get(file.getAbsolutePath());
            
            if (!currentHash.equals(cachedHash)) {
                // æ–‡ä»¶å·²å˜åŒ–ï¼Œé‡æ–°ç´¢å¼•
                reindexFile(file);
                fileHashCache.put(file.getAbsolutePath(), currentHash);
            }
        }
    }
}
```

---

## ğŸ¯ æ¨èçš„JVMå‚æ•°

### å¼€å‘ç¯å¢ƒ
```bash
java -Xms512m \
     -Xmx2g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/logs/heapdump.hprof \
     -jar your-app.jar
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆå¤§è§„æ¨¡æ•°æ®ï¼‰
```bash
java -Xms2g \
     -Xmx8g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=100 \
     -XX:G1HeapRegionSize=16m \
     -XX:+ParallelRefProcEnabled \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/logs/heapdump.hprof \
     -XX:+PrintGCDetails \
     -XX:+PrintGCDateStamps \
     -Xloggc:/logs/gc.log \
     -jar your-app.jar
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æ•ˆæœé¢„æµ‹

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-------|-------|-------|------|
| å¤„ç†1000ä¸ªå°æ–‡ä»¶å†…å­˜å³°å€¼ | ~800MB | ~300MB | 62% â†“ |
| å¤„ç†10ä¸ªå¤§æ–‡ä»¶å†…å­˜å³°å€¼ | ~2GB (å¯èƒ½OOM) | ~600MB | 70% â†“ |
| æŸ¥è¯¢å“åº”æ—¶é—´ | ~500ms | ~200ms | 60% â†‘ |
| ç´¢å¼•æ„å»ºæ—¶é—´ | åŸºå‡† | -20% | 20% â†‘ |
| ç£ç›˜å ç”¨ï¼ˆå‹ç¼©åï¼‰ | åŸºå‡† | -40% | 40% â†“ |

---

## âœ… è¡ŒåŠ¨æ¸…å•

### ç«‹å³æ‰§è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
- [ ] æ·»åŠ æ–‡æ¡£å¤§å°æ£€æŸ¥å’Œé™åˆ¶
- [ ] å®ç°åŸºäºå†…å­˜çš„åŠ¨æ€æ‰¹å¤„ç†
- [ ] åœ¨TikaDocumentParserä¸­è®¾ç½®è§£æä¸Šé™
- [ ] æ·»åŠ å†…å­˜ä½¿ç”¨ç›‘æ§æ—¥å¿—
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯å†…å­˜å ç”¨

### çŸ­æœŸè®¡åˆ’ï¼ˆæœ¬å‘¨å®Œæˆï¼‰
- [ ] å®ç°æ–‡æ¡£åˆ†å—ï¼ˆChunkingï¼‰åŠŸèƒ½
- [ ] ä¼˜åŒ–æ‰¹å¤„ç†æäº¤ç­–ç•¥
- [ ] æ·»åŠ æ€§èƒ½æµ‹è¯•ç”¨ä¾‹
- [ ] ç¼–å†™å†…å­˜å‹æµ‹è„šæœ¬

### ä¸­æœŸè®¡åˆ’ï¼ˆæœ¬æœˆå®Œæˆï¼‰
- [ ] å®ç°å»¶è¿ŸåŠ è½½æœºåˆ¶
- [ ] æ·»åŠ æµå¼å¤„ç†æ”¯æŒ
- [ ] ä¼˜åŒ–ç´¢å¼•ç»“æ„
- [ ] å®Œå–„ç›‘æ§å’Œå‘Šè­¦

### é•¿æœŸè§„åˆ’ï¼ˆå­£åº¦ç›®æ ‡ï¼‰
- [ ] å¼•å…¥å†…å­˜æ± ç®¡ç†
- [ ] å®ç°åˆ†å¸ƒå¼ç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] å®Œå–„å®¹é”™å’Œæ¢å¤æœºåˆ¶
- [ ] æ€§èƒ½è°ƒä¼˜å’Œå‹æµ‹

---

## ğŸ“š å‚è€ƒèµ„æº

### Apache Tikaæ€§èƒ½ä¼˜åŒ–
- [Tika Parser Configuration](https://tika.apache.org/2.9.1/configuring.html)
- [Handling Large Files with Tika](https://tika.apache.org/2.9.1/detection.html#Metadata-Based_Detection)

### Luceneå†…å­˜ä¼˜åŒ–
- [Lucene Indexing Performance Tips](https://lucene.apache.org/core/9_8_0/core/org/apache/lucene/index/IndexWriter.html)
- [Managing Lucene Memory](https://lucene.apache.org/core/9_8_0/core/org/apache/lucene/index/IndexWriterConfig.html)

### Javaå†…å­˜ç®¡ç†
- [G1GC Tuning Guide](https://docs.oracle.com/en/java/javase/17/gctuning/)
- [JVM Memory Management Best Practices](https://docs.oracle.com/en/java/javase/17/troubleshoot/memory-leaks.html)

---

## ğŸ“ æ€»ç»“

å½“å‰çš„ExcelçŸ¥è¯†åº“ç¤ºä¾‹åœ¨å¤„ç†**ä¸­å°è§„æ¨¡æ•°æ®**æ—¶è¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨é¢å¯¹**å¤§è§„æ¨¡Excelæ–‡ä»¶**æˆ–**å¤§æ‰¹é‡å¤„ç†**æ—¶å­˜åœ¨æ˜æ˜¾çš„å†…å­˜å’Œæ€§èƒ½ç“¶é¢ˆã€‚

### å…³é”®é£é™©ç‚¹
1. âš ï¸ **å•æ–‡ä»¶è¶…è¿‡50MBæ—¶OOMé£é™©æé«˜**
2. âš ï¸ **æ‰¹é‡å¤„ç†1000+æ–‡ä»¶æ—¶å†…å­˜å ç”¨ä¸å¯æ§**
3. âš ï¸ **Tikaè§£ææ— é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º**

### å»ºè®®ä¼˜å…ˆçº§
1. **P0ï¼ˆç´§æ€¥ï¼‰**: æ·»åŠ æ–‡ä»¶å¤§å°é™åˆ¶å’Œå†…å­˜ç›‘æ§
2. **P1ï¼ˆé‡è¦ï¼‰**: å®ç°æ–‡æ¡£åˆ†å—å’ŒåŠ¨æ€æ‰¹å¤„ç†
3. **P2ï¼ˆä¼˜åŒ–ï¼‰**: å»¶è¿ŸåŠ è½½å’Œæµå¼å¤„ç†
4. **P3ï¼ˆå¢å¼ºï¼‰**: å†…å­˜æ± ç®¡ç†å’Œåˆ†å¸ƒå¼æ”¯æŒ

é€šè¿‡å®æ–½ä¸Šè¿°ä¼˜åŒ–æ–¹æ¡ˆï¼Œé¢„è®¡å¯ä»¥å°†å†…å­˜å ç”¨é™ä½**60-70%**ï¼ŒåŒæ—¶æå‡**20-30%**çš„å¤„ç†æ€§èƒ½ã€‚

---

**æŠ¥å‘Šç”Ÿæˆå™¨**: GitHub Copilot  
**å®¡é˜…çŠ¶æ€**: âš ï¸ å¾…äººå·¥ç¡®è®¤å’Œæµ‹è¯•éªŒè¯  
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: è¯·æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯é€‰æ‹©åˆé€‚çš„ä¼˜åŒ–æ–¹æ¡ˆè¿›è¡Œå®æ–½

